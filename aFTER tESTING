OLD MACRO  only For Refrense of HOW Correction Made and  ====+++++++++++++++++++++++++
Option Explicit

Public Sub LoginUser()
    Dim wsLogin As Worksheet, wsUser As Worksheet
    Dim entID As String

    Set wsLogin = Sheets("Login")
    entID = Trim(wsLogin.Range("B3").value)

    If entID = "" Then
        MsgBox "Please select your Enterprise ID from the dropdown.", vbExclamation, "Login Required"
        wsLogin.Range("B3").Select
        Exit Sub
    End If

    ' Check if user sheet exists
    On Error Resume Next
    Set wsUser = Sheets(entID)
    On Error GoTo 0

    If wsUser Is Nothing Then
        MsgBox "User Not found. Please add User to continue.", vbExclamation, "User Not Found"
        Exit Sub
    End If

    ' Don't hide other users' sheets - allow multiple users
    wsUser.Visible = xlSheetVisible

    ' Sync B3 value to D6 in user sheet
    wsUser.Unprotect
    wsUser.Range("D6").value = entID
    wsUser.Range("D6").Locked = True
    wsUser.Protect UserInterfaceOnly:=True, AllowFiltering:=True

    ' Activate user sheet, select cell D8, and set zoom to 80%
    wsUser.Activate
    wsUser.Range("D12").Select
    ActiveWindow.Zoom = 80
MsgBox "Welcome, " & Application.userName & "!" & vbNewLine & _
       "ID *" & entID & "* logged in successfully." & vbNewLine & _
       "Your timesheet is ready." & vbNewLine & vbNewLine & _
       "Have a productive day!", _
       vbInformation, "Login Successful"


End Sub





' ==== SUBMIT TIMESHEET WITH FIXED NUMBERING ====
Public Sub SubmitTimesheet()
    On Error GoTo ErrorHandler

    Dim wsForm As Worksheet, wsDB As Worksheet
    Dim nextRow As Long
    Dim timesheetType As String, enterpriseID As String, uniqueCode As String
    Dim employeeName As String, employeeEmail As String, monthName As String, WeekName As String, regionName As String
    Dim engagementID As String, engagementHours As Variant, teamName As String
    Dim nonAuditEngagementName As String, nonAuditEngagementHours As Variant, remarks As String
    Dim submittedBy As String, debugMsg As String
    Dim isCorrection As Boolean
    Dim combinedMonthWeek As String

    Set wsForm = ActiveSheet
    Set wsDB = ThisWorkbook.Sheets("Data base")
    debugMsg = "Starting submission process..." & vbCrLf

    ' Gather all form values
    enterpriseID = Trim(wsForm.Range("D6").value)
    employeeName = Trim(wsForm.Range("D8").value)
    employeeEmail = Trim(wsForm.Range("D10").value)
    timesheetType = Trim(wsForm.Range("D12").value)
    monthName = Trim(wsForm.Range("D14").value)
    WeekName = Trim(wsForm.Range("E14").value)
    combinedMonthWeek = monthName & " : " & WeekName
    regionName = Trim(wsForm.Range("D16").value)
    engagementID = Trim(wsForm.Range("H6").value)
    engagementHours = wsForm.Range("H8").value
    teamName = Trim(wsForm.Range("H10").value)
    nonAuditEngagementName = Trim(wsForm.Range("H12").value)
    nonAuditEngagementHours = wsForm.Range("H14").value
    remarks = Trim(wsForm.Range("H16").value)
    uniqueCode = Trim(wsForm.Range("AT1").value)
    submittedBy = Application.userName

    ' Check if this is a correction
    isCorrection = LCase(timesheetType) = "timesheet entry correction"

    ' Validations
    If Not ValidateRequiredFields(wsForm, enterpriseID, timesheetType, monthName, WeekName, regionName, teamName) Then GoTo CleanUp
    If Not ValidateEngagementPairs(wsForm) Then GoTo CleanUp

    debugMsg = debugMsg & "Validation passed" & vbCrLf

    ' Disable events during processing
    Application.EnableEvents = False
    Application.ScreenUpdating = False

    ' CRITICAL: Ensure sheet is unprotected for writing
    wsForm.Unprotect
    debugMsg = debugMsg & "Sheet unprotected" & vbCrLf

    ' FIXED CORRECTION LOGIC WITH PRESERVED NUMBERING
    If isCorrection Then
        If uniqueCode = "" Then
            MsgBox "Unique code missing for correction.", vbExclamation
            GoTo CleanUp
        End If

        ' Store the original code to preserve it
        Dim originalCode As String
        originalCode = uniqueCode

      Dim foundLocalRow As Long, foundDBRow As Long
        foundLocalRow = FindLocalRow(wsForm, uniqueCode, enterpriseID)
        foundDBRow = FindDBRow(wsDB, uniqueCode, enterpriseID)

        If foundLocalRow = 0 And foundDBRow = 0 Then
            MsgBox "Record not found in local storage or database. Please select New Timesheet Entry.", _
                   vbExclamation, "Record Not Found"
            wsForm.Range("D12").value = "New Timesheet entry"
            ClearCorrectionFields wsForm
            GoTo CleanUp
        ElseIf foundLocalRow > 0 Then
            ' Mark for deletion instead of deleting immediately
            MarkLocalRowForDeletion wsForm, uniqueCode, enterpriseID
            debugMsg = debugMsg & "Local record marked for deletion for correction" & vbCrLf
        ElseIf foundDBRow > 0 Then
            ' Load from database and mark for deletion in DB
            LoadFromDatabase wsForm, wsDB, foundDBRow
            wsDB.Unprotect
            MarkDBRowForDeletion wsDB, foundDBRow
            wsDB.Protect UserInterfaceOnly:=True
            debugMsg = debugMsg & "Database record loaded and marked for deletion for correction" & vbCrLf
        End If

        ' CRITICAL: Preserve the original unique code for corrections
        uniqueCode = originalCode
        debugMsg = debugMsg & "Correction mode - preserved original code: " & uniqueCode & vbCrLf
    Else
       ' Check for duplicates in new entries
If LCase(timesheetType) = "new timesheet entry" Then
    Dim duplicateLocalRow As Long, duplicateDBRow As Long
    duplicateLocalRow = FindDuplicateLocal(wsForm, enterpriseID, engagementID, monthName, WeekName, regionName, teamName)
    duplicateDBRow = FindDuplicateDB(wsDB, enterpriseID, engagementID, monthName, WeekName, regionName, teamName)

    If duplicateLocalRow > 0 Or duplicateDBRow > 0 Then
        Dim duplicateCode As String
        If duplicateLocalRow > 0 Then
            duplicateCode = wsForm.Cells(duplicateLocalRow, 2).value
        Else
            duplicateCode = wsDB.Cells(duplicateDBRow, 1).value
        End If

        Dim response As VbMsgBoxResult
        response = MsgBox("This entry already exists (Unique Code: " & duplicateCode & ")." & vbNewLine & _
                          "Do you want to make a correction instead?", vbYesNo + vbExclamation, "Duplicate Entry")

        If response = vbYes Then
            wsForm.Range("D12").value = "Timesheet Entry Correction"
            wsForm.Range("AT1").value = duplicateCode
            MsgBox "Please proceed with the correction using the existing data.", vbInformation, "Correction Mode"
            Exit Sub
        Else
            MsgBox "Submission cancelled. Please review your entry.", vbInformation, "Submission Cancelled"
            Exit Sub
        End If
    End If
End If

        ' FIXED: Get next sequential code checking both local and database
        uniqueCode = GetNextLocalCode(wsForm)
        debugMsg = debugMsg & "New entry, assigned sequential code: " & uniqueCode & vbCrLf
    End If

    ' Confirmation
    If MsgBox("Are you sure you want to submit the timesheet?" & vbCrLf & "Code: " & uniqueCode, _
              vbQuestion + vbYesNo, "Confirm Submission") = vbNo Then
        MsgBox "Submission cancelled.", vbInformation
        GoTo CleanUp
    End If
    ' If this is a correction, delete any previous corrections for this unique code
If isCorrection Then
    DeletePreviousCorrections wsForm, uniqueCode, enterpriseID
End If


    ' Find next storage row
    nextRow = wsForm.Cells(wsForm.Rows.count, "B").End(xlUp).Row
    If nextRow < 3000 Then nextRow = 2999
    nextRow = nextRow + 1
    debugMsg = debugMsg & "Writing to row: " & nextRow & vbCrLf

   ' Write data to local storage with verification
    With wsForm
        .Cells(nextRow, 2).value = uniqueCode
        .Cells(nextRow, 3).value = enterpriseID
        .Cells(nextRow, 4).value = employeeName
        .Cells(nextRow, 5).value = employeeEmail
        .Cells(nextRow, 6).value = Format(Now, "yyyy-mm-dd hh:mm:ss")
        .Cells(nextRow, 7).value = timesheetType
        .Cells(nextRow, 8).value = combinedMonthWeek ' Store combined month and week
        .Cells(nextRow, 9).value = regionName
        .Cells(nextRow, 10).value = engagementID
        .Cells(nextRow, 11).value = engagementHours
        .Cells(nextRow, 12).value = teamName
        .Cells(nextRow, 13).value = nonAuditEngagementName
        .Cells(nextRow, 14).value = nonAuditEngagementHours
        .Cells(nextRow, 15).value = remarks
        .Cells(nextRow, 16).value = submittedBy
        ' Colur of Font no fill
         .Cells(nextRow, 2).Resize(1, 15).Font.Color = RGB(255, 255, 255)
    End With
    

    ' Verify data was written correctly
    If wsForm.Cells(nextRow, 2).value <> uniqueCode Then
        MsgBox "CRITICAL ERROR: Data verification failed!" & vbCrLf & _
               "Expected code: " & uniqueCode & vbCrLf & _
               "Found: " & wsForm.Cells(nextRow, 2).value, vbCritical
        GoTo CleanUp
    End If

    debugMsg = debugMsg & "Data written and verified successfully" & vbCrLf

    ' Auto-save workbook
    ThisWorkbook.Save
    debugMsg = debugMsg & "Workbook saved" & vbCrLf

    ' Success message
    Dim msgType As String
    msgType = IIf(isCorrection, "CORRECTION", "NEW ENTRY")

    MsgBox "SUCCESS! " & msgType & " stored locally!" & vbCrLf & _
           "Unique Code: " & uniqueCode & vbCrLf & _
           "Enterprise ID: " & enterpriseID & vbCrLf & _
           "Will be synced to database By Admin." & vbCrLf & vbCrLf & _
           "Use ' Double Click to Show Past Records' to view your latest submissions.", vbInformation, "Submission Complete"

    ' Reset form inputs only (preserve local storage and past records)
    ResetFormInputsOnly wsForm

    GoTo CleanUp

ErrorHandler:
    MsgBox "ERROR in SubmitTimesheet:" & vbCrLf & _
           "Error: " & Err.Description & vbCrLf & _
           "Number: " & Err.Number & vbCrLf & vbCrLf & _
           "Debug Info:" & vbCrLf & debugMsg, vbCritical, "System Error"

CleanUp:
    On Error Resume Next
    wsForm.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Call UpdatePendingCounts

    ' Ensure we stay on the user's sheet
    wsForm.Activate
End Sub

' ==== FIXED UNIQUE CODE GENERATION - CHECKS BOTH LOCAL AND DATABASE ====
Private Function GetNextLocalCode(ws As Worksheet) As String
    Dim maxCodeLocal As Long, maxCodeDB As Long
    Dim r As Long, lastRow As Long
    Dim entID As String
    
    entID = ws.Range("D6").value
    
    ' Check local storage for this Enterprise ID
    maxCodeLocal = 0
    lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
    For r = 3000 To lastRow
        If ws.Cells(r, 3).value = entID Then ' Column C = Enterprise ID
            If IsNumeric(ws.Cells(r, 2).value) And ws.Cells(r, 2).value <> "" Then
                If ws.Cells(r, 2).value > maxCodeLocal Then
                    maxCodeLocal = ws.Cells(r, 2).value
                End If
            End If
        End If
    Next r
    
    ' Check database records for this Enterprise ID
    Dim wsDB As Worksheet
    Set wsDB = ThisWorkbook.Sheets("Data base")
    maxCodeDB = 0
    lastRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    For r = 2 To lastRow ' Start from row 2 (skip header)
        If wsDB.Cells(r, 2).value = entID Then ' Column B = Enterprise ID in database
            If IsNumeric(wsDB.Cells(r, 1).value) And wsDB.Cells(r, 1).value <> "" Then
                If wsDB.Cells(r, 1).value > maxCodeDB Then
                    maxCodeDB = wsDB.Cells(r, 1).value
                End If
            End If
        End If
    Next r
    
    ' The next code is the higher of both + 1
    GetNextLocalCode = CStr(Application.Max(maxCodeLocal, maxCodeDB) + 1)
End Function

' ==== HELPER FUNCTIONS FOR DATABASE CORRECTION ====
Private Function FindDBRow(wsDB As Worksheet, code As String, entID As String) As Long
    Dim lastRow As Long, r As Long
    lastRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    For r = 2 To lastRow
        If wsDB.Cells(r, 1).value = code And wsDB.Cells(r, 2).value = entID Then
            FindDBRow = r
            Exit Function
        End If
    Next r
    FindDBRow = 0
End Function

Private Sub LoadFromDatabase(wsForm As Worksheet, wsDB As Worksheet, dbRow As Long)
    Dim combinedMonthWeek As String
    Dim monthPart As String, weekPart As String

    combinedMonthWeek = wsDB.Cells(dbRow, 7).value ' Combined Month_Week

    ' Split the combined value
    If InStr(combinedMonthWeek, " : ") > 0 Then
        monthPart = Split(combinedMonthWeek, " : ")(0)
        weekPart = Split(combinedMonthWeek, " : ")(1)
    Else
        monthPart = combinedMonthWeek
        weekPart = ""
    End If

    wsForm.Range("D14").value = monthPart ' Month
    wsForm.Range("E14").value = weekPart ' Week
    wsForm.Range("D16").value = wsDB.Cells(dbRow, 8).value ' Region
    wsForm.Range("H6").value = wsDB.Cells(dbRow, 9).value ' Engagement ID
    wsForm.Range("H8").value = wsDB.Cells(dbRow, 10).value ' Engagement Hours
    wsForm.Range("H10").value = wsDB.Cells(dbRow, 11).value ' Team Name
    wsForm.Range("H12").value = wsDB.Cells(dbRow, 12).value ' Non-Audit Name
    wsForm.Range("H14").value = wsDB.Cells(dbRow, 13).value ' Non-Audit Hours
    wsForm.Range("H16").value = wsDB.Cells(dbRow, 14).value ' Remarks
End Sub

    

' ==== TOGGLE MY DATABASE RECORDS (ENHANCED) ====
Public Sub ToggleMyDatabaseRecords()
    Dim wsF As Worksheet, wsDB As Worksheet
    Dim entID As String, i As Long, lastRow As Long, outRow As Long
    Dim startCell As Range, tblArea As Range
    Dim isDataPresent As Boolean

    Set wsF = ActiveSheet
    Set wsDB = ThisWorkbook.Sheets("Data base")
    Set startCell = wsF.Range("B25")
    Set tblArea = wsF.Range("B25:Q297") ' CAREFUL: Ends before row 3000 (local storage)

    entID = Trim(wsF.Range("D6").value)
    If entID = "" Then
        MsgBox "Please verify Enterprise ID is populated.", vbExclamation
        Exit Sub
    End If

    ' Unprotect the sheet
    On Error Resume Next
    wsF.Unprotect
    On Error GoTo 0

    ' Check if data exists below the header
    isDataPresent = WorksheetFunction.CountA(tblArea.Offset(1)) > 0

    If isDataPresent Then
        ' Clear existing data
        tblArea.Offset(1).ClearContents
        tblArea.Offset(1).ClearFormats
        tblArea.Offset(1).Interior.ColorIndex = xlNone
        tblArea.Offset(1).Borders.LineStyle = xlNone

        ' Clear headers as well
        startCell.Resize(1, 16).ClearContents
        startCell.Resize(1, 16).ClearFormats

        ' Reprotect the sheet
        On Error Resume Next
        wsF.Protect UserInterfaceOnly:=True, AllowFiltering:=True
        On Error GoTo 0
        MsgBox "You past timesheet records have been hidden. Please click again to show them", vbInformation, "Toggle Complete"
        Exit Sub
    End If

    ' If we reach here, it means there's no data, so we proceed to show records

   ' Headers
    startCell.Resize(1, 16).value = Array("Unique Code", "Enterprise ID", "Employee Name", "Employee Email", _
        "Submitted Time", "Type", "Month_Week", "Region", "Engagement ID", "Engagement Hr", "Team Name", _
        "Non-Audit Eng Name", "Non-Audit Hr", "Remarks", "Submitted By", "Sync Status")
        
    With startCell.Resize(1, 16)
        .Font.Bold = True
        .Interior.Color = RGB(200, 200, 200)
        .Borders.LineStyle = xlContinuous
        .HorizontalAlignment = xlCenter
    End With

    outRow = 1

    ' Show database records (synced) - sorted by unique code
    lastRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    If lastRow >= 2 Then
        For i = 2 To lastRow
        
            If wsDB.Cells(i, 2).value = entID Then
                startCell.Offset(outRow).Resize(1, 15).value = wsDB.Range(wsDB.Cells(i, 1), wsDB.Cells(i, 15)).value
                startCell.Offset(outRow, 15).value = "Synced"
                startCell.Offset(outRow, 15).Interior.Color = RGB(200, 255, 200) ' Light green
                outRow = outRow + 1
            End If
        Next i
    End If

    ' Show local pending records - sorted by unique code
    Dim localLastRow As Long
    localLastRow = wsF.Cells(wsF.Rows.count, "B").End(xlUp).Row
    If localLastRow >= 3000 Then
        For i = 3000 To localLastRow
            If wsF.Cells(i, 2).value <> "" And wsF.Cells(i, 3).value = entID Then
                startCell.Offset(outRow).Resize(1, 15).value = wsF.Range(wsF.Cells(i, 2), wsF.Cells(i, 16)).value
                startCell.Offset(outRow, 15).value = "Pending Sync"
                startCell.Offset(outRow, 15).Interior.Color = RGB(255, 255, 200) ' Light yellow
                outRow = outRow + 1
            End If
        Next i
    End If

    ' Format data rows
    If outRow > 1 Then
        With startCell.Offset(1).Resize(outRow - 1, 16)
            .Borders.LineStyle = xlContinuous
            .HorizontalAlignment = xlLeft
        End With

        ' Alternate row colors
        For i = 2 To outRow - 1 Step 2
            startCell.Offset(i).Resize(1, 16).Interior.Color = RGB(240, 240, 240)
        Next i

        MsgBox outRow - 1 & " Record(s) displayed for " & entID
    Else
        MsgBox "No records found for Enterprise ID: " & entID, vbInformation, "No Records"
    End If

    ' Reprotect the sheet
    On Error Resume Next
    wsF.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    On Error GoTo 0
End Sub
' ==== NEW FUNCTION TO MARK LOCAL ROW FOR DELETION ====
Private Sub MarkLocalRowForDeletion(ws As Worksheet, code As String, entID As String)
    Dim r As Long
    r = FindLocalRow(ws, code, entID)
    If r > 0 Then
        ws.Cells(r, 17).value = "Marked for Deletion" ' Assuming column Q is unused
        ws.Cells(r, 17).Interior.Color = RGB(255, 200, 200) ' Light red background
    End If
End Sub

' ==== NEW FUNCTION TO MARK DB ROW FOR DELETION ====
Private Sub MarkDBRowForDeletion(wsDB As Worksheet, dbRow As Long)
    wsDB.Cells(dbRow, 16).value = "Marked for Deletion" ' Assuming column P is unused in DB
    wsDB.Cells(dbRow, 16).Interior.Color = RGB(255, 200, 200) ' Light red background
End Sub

' ==== ADMIN SYNC WITH PASSWORD ====
Public Sub SyncAllUserSheetsToDatabase()
    On Error GoTo ErrorHandler

    Dim pass As String
    pass = InputBox("Enter sync password:", "Admin Sync Required")
    If pass <> "123" Then
        MsgBox "Incorrect password. Access denied.", vbCritical, "Access Denied"
        Exit Sub
    End If

    Dim ws As Worksheet, wsDB As Worksheet, wsLogin As Worksheet, wsAdmin As Worksheet
    Dim r As Long, lastLocalRow As Long, nextDBRow As Long
    Dim recordCount As Long, userCount As Long, deletedCount As Long

    recordCount = 0
    userCount = 0
    deletedCount = 0
    Set wsDB = ThisWorkbook.Sheets("Data base")
    Set wsAdmin = ThisWorkbook.Sheets("Admin")

    wsDB.Unprotect

    ' First, process deletions in the database
    Dim lastDBRow As Long
    lastDBRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    For r = lastDBRow To 2 Step -1
        If wsDB.Cells(r, 16).value = "Marked for Deletion" Then
            wsDB.Rows(r).Delete
            deletedCount = deletedCount + 1
        End If
    Next r
    ' Create a collection to store the latest corrections
Dim latestCorrections As New Collection
On Error Resume Next ' In case of duplicate keys

' First pass: identify the latest corrections
For r = lastLocalRow To 3000 Step -1
    If ws.Cells(r, 2).value <> "" Then
        Dim key As String
        key = ws.Cells(r, 2).value & "_" & ws.Cells(r, 3).value ' Unique Code + Enterprise ID
        If LCase(ws.Cells(r, 7).value) = "timesheet entry correction" Then
            latestCorrections.Add r, key
        End If
    End If
Next r

On Error GoTo 0 ' Reset error handling



    ' Process each user sheet
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Data base" And ws.Name <> "Login" And ws.Name <> "Admin" Then
            lastLocalRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
            If lastLocalRow >= 3000 Then
                Dim userRecords As Long: userRecords = 0
                For r = 3000 To lastLocalRow
                    If ws.Cells(r, 2).value <> "" Then
                        If ws.Cells(r, 17).value <> "Marked for Deletion" Then
                            nextDBRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row + 1
                            wsDB.Cells(nextDBRow, 1).Resize(1, 15).value = ws.Cells(r, 2).Resize(1, 15).value
                            recordCount = recordCount + 1
                            userRecords = userRecords + 1
                        Else
                            deletedCount = deletedCount + 1
                        End If
                    End If
                Next r

                If userRecords > 0 Or deletedCount > 0 Then
                    ' Unprotect the sheet before clearing contents
                    On Error Resume Next
                    ws.Unprotect
                    On Error GoTo ErrorHandler

                    ' Clear local storage after successful sync
                    ws.Range("B3000:Q" & lastLocalRow).ClearContents
                    ws.Range("B3000:Q" & lastLocalRow).Interior.ColorIndex = xlNone
                    userCount = userCount + 1

                    ' Protect the sheet again
                    On Error Resume Next
                    ws.Protect
                    On Error GoTo ErrorHandler
                End If
            End If
        End If
    Next ws

    wsDB.Protect UserInterfaceOnly:=True

    ' Update sync timestamp
    wsAdmin.Range("G5").value = Format(Now, "yyyy-mm-dd hh:mm:ss")

    ' Save workbook
    ThisWorkbook.Save

    MsgBox "SYNC COMPLETED!" & vbCrLf & _
           "Users processed: " & userCount & vbCrLf & _
           "Records synced: " & recordCount & vbCrLf & _
           "Records deleted: " & deletedCount & vbCrLf & _
           "All local buffers cleared." & vbCrLf & _
           "Last sync: " & Format(Now, "yyyy-mm-dd hh:mm:ss"), vbInformation, "Sync Complete"
    Call UpdatePendingCounts
    Call LogoutAllUserSheets
    Exit Sub

ErrorHandler:
    MsgBox "An error occurred: " & Err.Description, vbCritical, "Error"
    On Error Resume Next
    wsDB.Protect UserInterfaceOnly:=True
    ThisWorkbook.Save
End Sub


' ==== SUPPORT FUNCTIONS ====
Private Function FindLocalRow(ws As Worksheet, code As String, entID As String) As Long
    Dim r As Long, lastRow As Long
    lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
    For r = 3000 To lastRow
        If ws.Cells(r, 2).value = code And ws.Cells(r, 3).value = entID Then
            FindLocalRow = r
            Exit Function
        End If
    Next r
    FindLocalRow = 0
End Function

Private Sub DeleteLocalRow(ws As Worksheet, code As String, entID As String)
    Dim r As Long
    r = FindLocalRow(ws, code, entID)
    If r > 0 Then ws.Rows(r).Delete Shift:=xlUp
End Sub
Private Function FindDuplicateLocal(ws As Worksheet, enterpriseID As String, engagementID As String, monthName As String, WeekName As String, regionName As String, teamName As String) As Long
    Dim r As Long, lastRow As Long
    lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
    For r = 3000 To lastRow
        If LCase(ws.Cells(r, 3).value) = LCase(enterpriseID) And _
           LCase(ws.Cells(r, 10).value) = LCase(engagementID) And _
           LCase(Split(ws.Cells(r, 8).value, " : ")(0)) = LCase(monthName) And _
           LCase(Split(ws.Cells(r, 8).value, " : ")(1)) = LCase(WeekName) And _
           LCase(ws.Cells(r, 9).value) = LCase(regionName) And _
           LCase(ws.Cells(r, 12).value) = LCase(teamName) And _
           LCase(ws.Cells(r, 7).value) = "new timesheet entry" Then
           FindDuplicateLocal = r
           Exit Function
        End If
    Next r
    FindDuplicateLocal = 0
End Function
Private Function FindDuplicateDB(wsDB As Worksheet, enterpriseID As String, engagementID As String, monthName As String, WeekName As String, regionName As String, teamName As String) As Long
    Dim r As Long, lastRow As Long
    lastRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    For r = 2 To lastRow
        If LCase(wsDB.Cells(r, 2).value) = LCase(enterpriseID) And _
           LCase(wsDB.Cells(r, 9).value) = LCase(engagementID) And _
           LCase(Split(wsDB.Cells(r, 7).value, " : ")(0)) = LCase(monthName) And _
           LCase(Split(wsDB.Cells(r, 7).value, " : ")(1)) = LCase(WeekName) And _
           LCase(wsDB.Cells(r, 8).value) = LCase(regionName) And _
           LCase(wsDB.Cells(r, 11).value) = LCase(teamName) Then
           FindDuplicateDB = r
           Exit Function
        End If
    Next r
    FindDuplicateDB = 0
End Function


' ==== VALIDATIONS ====
Private Function ValidateRequiredFields(wsForm As Worksheet, enterpriseID As String, timesheetType As String, monthName As String, WeekName As String, regionName As String, teamName As String) As Boolean
    ValidateRequiredFields = True
    If enterpriseID = "" Then
        MsgBox "Enterprise ID is required.", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
    If timesheetType = "" Then
        MsgBox "Please select Timesheet Type.", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
    If monthName = "" Then
        MsgBox "Please select Month.", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
    If WeekName = "" Then
        MsgBox "Please select Week", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
    If regionName = "" Then
        MsgBox "Please select Region.", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
    If teamName = "" Then
        MsgBox "Please select Your Team.", vbExclamation: ValidateRequiredFields = False: Exit Function
    End If
End Function

Private Function ValidateEngagementPairs(wsForm As Worksheet) As Boolean
    Dim engagementFilled As Boolean, nonAuditEngagementFilled As Boolean
    engagementFilled = (Len(Trim(wsForm.Range("H6").value)) > 0 And Len(Trim(wsForm.Range("H8").value)) > 0)
    nonAuditEngagementFilled = (Len(Trim(wsForm.Range("H12").value)) > 0 And Len(Trim(wsForm.Range("H14").value)) > 0)
    
    ValidateEngagementPairs = True
    If Not (engagementFilled Or nonAuditEngagementFilled) Then
        MsgBox "Please fill either Engagement ID + Hours OR Non-Audit Engagement + Hours.", vbExclamation, "Validation Error"
        ValidateEngagementPairs = False: Exit Function
    End If
    
    If (Len(Trim(wsForm.Range("H6").value)) > 0 Xor Len(Trim(wsForm.Range("H8").value)) > 0) _
        Or (Len(Trim(wsForm.Range("H12").value)) > 0 Xor Len(Trim(wsForm.Range("H14").value)) > 0) Then
        MsgBox "Please ensure both fields are filled for the selected engagement type.", vbExclamation, "Validation Error"
        ValidateEngagementPairs = False: Exit Function
    End If
End Function

' ==== FORM MANAGEMENT ====
Private Sub ResetFormInputsOnly(f As Worksheet)
    Application.EnableEvents = False
    f.Unprotect
    
    ' Store existing formulas
    Dim nameFormula As String, emailFormula As String
    nameFormula = f.Range("D8").Formula
    emailFormula = f.Range("D10").Formula
    
    ' Clear only form input fields (NOT past records display or local storage)
    f.Range("D12,D14,E14,D16,H6,H8,H10,H12,H14,H16,AT1").ClearContents
    f.Range("D12").value = "New Timesheet Entry"
    
    ' Restore XLOOKUP formulas
    If nameFormula <> "" Then f.Range("D8").Formula = nameFormula
    If emailFormula <> "" Then f.Range("D10").Formula = emailFormula
    
    ' Maintain protection settings
    f.Cells.Locked = True
    f.Range("D6,D8,D10").Locked = True
    f.Range("D12,D14,E14,D16,H6,H8,H10,H12,H14,H16").Locked = False
    f.Range("B3000:Q" & f.Rows.count).Locked = False ' Keep storage area unlocked
    
    f.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    Application.EnableEvents = True
End Sub

Public Sub ClearCorrectionFields(f As Worksheet)
    Application.EnableEvents = False
    f.Unprotect
    f.Range("D12,D14,E14,D16,H6,H8,H10,H12,H14,H16,AT1").ClearContents
    f.Range("D12").value = "New Timesheet Entry"
    f.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    Application.EnableEvents = True
End Sub
' ==== Delete correction locally ====
Private Sub DeletePreviousCorrections(ws As Worksheet, uniqueCode As String, enterpriseID As String)
    Dim lastRow As Long, r As Long
    lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row

    For r = lastRow To 3000 Step -1
        If ws.Cells(r, 2).value = uniqueCode And _
           ws.Cells(r, 3).value = enterpriseID And _
           LCase(ws.Cells(r, 7).value) = "timesheet entry correction" Then
            ws.Rows(r).Delete
        End If
    Next r
End Sub

' ==== LOGOUT FUNCTION (ENHANCED) ====
Public Sub LogoutUser()
    Dim response As VbMsgBoxResult
    response = MsgBox("Are you sure you want to logout?" & vbCrLf & _
                     "This will hide your Sheet.", vbYesNo + vbQuestion, "Confirm Logout")
    
    If response = vbYes Then
        ActiveSheet.Visible = xlSheetVeryHidden
        Sheets("Login").Activate
        Sheets("Login").Range("B3").ClearContents
        Sheets("Login").Range("B3").Select
        MsgBox "Logged out successfully. Please Close This Excel", vbInformation
    End If
End Sub

' ==== ADMIN FUNCTIONS ====
Public Sub ShowAllUserSheets()
    If InputBox("Enter admin password:") <> "123" Then
        MsgBox "Access denied": Exit Sub
    End If
    
    Dim ws As Worksheet, count As Long
    count = 0
    
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" Then
            ws.Visible = xlSheetVisible
            count = count + 1
        End If
    Next ws
    
    MsgBox count & " user sheets are now visible.", vbInformation
End Sub

Public Sub HideAllUserSheets()
    If InputBox("Enter admin password:") <> "123" Then
        MsgBox "Access denied": Exit Sub
    End If
    
    Dim ws As Worksheet, count As Long
    count = 0
    
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" Then
            ws.Visible = xlSheetVeryHidden
            count = count + 1
        End If
    Next ws
    
    Sheets("Login").Activate
    MsgBox count & " user sheets have been hidden.", vbInformation
End Sub
Public Sub LogoutAllUserSheets()
    Dim ws As Worksheet, count As Long
    count = 0

    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" And ws.Name <> "Admin" Then
            ws.Visible = xlSheetVeryHidden
            count = count + 1
        End If
    Next ws

    Sheets("Admin").Activate
End Sub



Public Sub UpdatePendingCounts()
    Dim ws As Worksheet
    Dim totalPending As Long
    Dim userCount As Long
    Dim lastRow As Long
    Dim sheetPending As Long
    
    totalPending = 0
    userCount = 0
    
    For Each ws In ThisWorkbook.Sheets
        ' Skip non-user sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" And ws.Name <> "DV" And ws.Name <> "Admin" Then
            lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
            If lastRow >= 3000 Then
                sheetPending = Application.WorksheetFunction.CountA(ws.Range("B3000:B" & lastRow))
                If sheetPending > 0 Then
                    totalPending = totalPending + sheetPending
                    userCount = userCount + 1
                End If
            End If
        End If
    Next ws
    
    ' Output to Admin sheet
    With ThisWorkbook.Sheets("Admin")
        .Range("G3").value = totalPending
        .Range("G4").value = userCount
    End With
End Sub

Public Sub AddUsersFromTable()
    On Error GoTo ErrorHandler

    Dim userRange As Range
    Dim userRow As Range
    Dim enterpriseID As String, employeeName As String, employeeEmail As String
    Dim successCount As Integer, failCount As Integer
    Dim incompleteCount As Integer, existingCount As Integer
    Dim wsDV As Worksheet

    Application.EnableEvents = False
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    ' Use the predefined MUser range
    Set userRange = ThisWorkbook.Names("MUser").RefersToRange

    If userRange Is Nothing Then
        MsgBox "MUser range not found. Please check the Name Manager.", vbExclamation
        Exit Sub
    End If

    ' Initialize counters
    successCount = 0
    failCount = 0
    incompleteCount = 0
    existingCount = 0

    ' Unprotect DV sheet
    Set wsDV = ThisWorkbook.Sheets("DV")
    wsDV.Unprotect

    ' Loop through each row in the MUser range (skip header row)
    For Each userRow In userRange.Rows
        If userRow.Row > userRange.Row Then ' Skip header row
            enterpriseID = Trim(userRow.Cells(1, 1).value)
            employeeName = Trim(userRow.Cells(1, 2).value)
            employeeEmail = Trim(userRow.Cells(1, 3).value)

            ' Only process rows where all fields are filled
            If enterpriseID <> "" And employeeName <> "" And employeeEmail <> "" Then
                ' Call AddNewUser function with error handling
                On Error Resume Next
                Call AddNewUser(enterpriseID, employeeName, employeeEmail)

                If Err.Number = 0 Then
                    successCount = successCount + 1
                ElseIf Err.Number = vbObjectError + 1 Then
                    existingCount = existingCount + 1
                Else
                    failCount = failCount + 1
                End If
                On Error GoTo ErrorHandler
            ElseIf enterpriseID <> "" Or employeeName <> "" Or employeeEmail <> "" Then
                ' If any field is filled but not all, count as incomplete
                incompleteCount = incompleteCount + 1
            End If
        End If
    Next userRow

    ' Update the Login dropdown after adding all users
    UpdateLoginDropdown

    ' Clear MUser range, leaving the header
    ClearMUserRange userRange

    ' Display results in a single message box
    Dim message As String
    Dim hasContent As Boolean
    hasContent = False

    message = "Process completed." & vbNewLine & vbNewLine

    If successCount > 0 Then
        message = message & "Users added successfully: " & successCount & vbNewLine
        hasContent = True
    End If

    If incompleteCount > 0 Then
        message = message & "Users with incomplete details: " & incompleteCount & vbNewLine
        hasContent = True
    End If

    If existingCount > 0 Then
        message = message & "Users already existing: " & existingCount & vbNewLine
        hasContent = True
    End If

    If failCount > 0 Then
        message = message & "Failed attempts: " & failCount & vbNewLine
        hasContent = True
    End If

    If Not hasContent Then
        message = message & "No users were processed."
    End If

    MsgBox message, vbInformation, "Add Users Result"

    GoTo CleanUp

ErrorHandler:
    MsgBox "An error occurred: " & Err.Description, vbCritical, "Error"

CleanUp:
    ' Re-protect DV sheet
    wsDV.Protect UserInterfaceOnly:=True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
End Sub


Private Sub ClearMUserRange(userRange As Range)
    ' Clear the MUser range, leaving the header
    If userRange.Rows.count > 1 Then
        userRange.Offset(1).ClearContents
    End If
End Sub

Public Sub AddNewUser(enterpriseID As String, employeeName As String, employeeEmail As String)
    On Error GoTo ErrorHandler

    Dim wsLogin As Worksheet, wsForm As Worksheet, wsDV As Worksheet, wsNew As Worksheet
    Dim nextDVRow As Long

    ' === Check if user already exists ===
    If SheetExists(enterpriseID) Then
        Err.Raise vbObjectError + 1, , "User '" & enterpriseID & "' already exists!"
    End If

    ' === Get Template Form (even if very hidden) ===
    Set wsForm = GetVeryHiddenSheet("Form")
    If wsForm Is Nothing Then
        Err.Raise vbObjectError + 2, , "Template sheet 'Form' not found!"
    End If

    ' === Get DV sheet ===
    Set wsDV = ThisWorkbook.Sheets("DV")
    If wsDV Is Nothing Then
        Err.Raise vbObjectError + 3, , "DV sheet not found!"
    End If

    ' === Create new sheet by copying Form ===
    Dim originalVisibility As XlSheetVisibility
    originalVisibility = wsForm.Visible
    wsForm.Visible = xlSheetVisible  ' Temporarily make Form visible
    wsForm.Copy After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.count)
    wsForm.Visible = originalVisibility  ' Set Form back to original visibility
    Set wsNew = ActiveSheet

    ' === Rename to Enterprise ID ===
    On Error Resume Next
    wsNew.Name = enterpriseID
    If Err.Number <> 0 Then
        Application.DisplayAlerts = False
        wsNew.Delete
        Application.DisplayAlerts = True
        Err.Raise vbObjectError + 4, , "Cannot rename sheet to '" & enterpriseID & "'. Please use a valid sheet name."
    End If
    On Error GoTo ErrorHandler

    ' === Setup new sheet data ===
    With wsNew
        .Unprotect

        ' Clear any existing data in key cells
        .Range("D6,D8,D10,AZ1").ClearContents

        ' Fill user data
        .Range("D6").value = enterpriseID
        .Range("D8").value = employeeName
        .Range("D10").value = employeeEmail
        .Range("AZ1").value = "Added: " & Format(Now, "yyyy-mm-dd hh:mm:ss")

        ' Set protection
        .Cells.Locked = True
        .Range("D6").Locked = True
        .Range("D8,D10,D12,D14,E14,D16,H6,H8,H10,H12,H14,H16,AT1").Locked = False
        .Range("B3000:P" & .Rows.count).Locked = False

        .Protect UserInterfaceOnly:=True, AllowFiltering:=True
    End With

    ' === Add to DV sheet ===
    wsDV.Unprotect
    nextDVRow = wsDV.Cells(wsDV.Rows.count, "F").End(xlUp).Row + 1
    If nextDVRow < 2 Then nextDVRow = 2 ' Start from row 2 if sheet is empty
    wsDV.Range("F" & nextDVRow).value = enterpriseID
    wsDV.Range("G" & nextDVRow).value = employeeName
    wsDV.Range("H" & nextDVRow).value = employeeEmail
    wsDV.Protect UserInterfaceOnly:=True

    ' === Try to copy VBA code (optional - might fail if security high) ===
    On Error Resume Next
    CopySheetMacrosSafe wsForm, wsNew
    On Error GoTo ErrorHandler

    ' === Update counters if function exists ===
    On Error Resume Next
    Call UpdatePendingCounts
    On Error GoTo ErrorHandler

    ' === Clear specified cells on the new user's sheet ===
    ClearNewUserFields wsNew

    Exit Sub

ErrorHandler:
    Err.Raise Err.Number, , Err.Description
End Sub

Private Function SheetExists(sheetName As String) As Boolean
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets(sheetName)
    SheetExists = Not ws Is Nothing
    On Error GoTo 0
End Function

Private Sub CopySheetMacrosSafe(sourceSheet As Worksheet, targetSheet As Worksheet)
    On Error Resume Next

    Dim sourceCode As Object, targetCode As Object
    Set sourceCode = ThisWorkbook.VBProject.VBComponents(sourceSheet.CodeName)
    Set targetCode = ThisWorkbook.VBProject.VBComponents(targetSheet.CodeName)

    If Not sourceCode Is Nothing And Not targetCode Is Nothing Then
        If sourceCode.CodeModule.CountOfLines > 0 Then
            targetCode.CodeModule.DeleteLines 1, targetCode.CodeModule.CountOfLines
            targetCode.CodeModule.AddFromString sourceCode.CodeModule.Lines(1, sourceCode.CodeModule.CountOfLines)
        End If
    End If

    ' If error occurs, just continue - VBA copying is optional
    On Error GoTo 0
End Sub

Private Sub UpdateLoginDropdown()
    On Error GoTo ErrorHandler

    Dim wsDV As Worksheet, wsLogin As Worksheet
    Dim lastRow As Long, dvRange As Range

    ' Check if DV and Login sheets exist
    If Not SheetExists("DV") Or Not SheetExists("Login") Then
        MsgBox "DV or Login sheet not found. Please check your workbook structure.", vbExclamation
        Exit Sub
    End If

    Set wsDV = ThisWorkbook.Sheets("DV")
    Set wsLogin = ThisWorkbook.Sheets("Login")

    ' Temporarily unprotect Login and DV sheets
    wsLogin.Unprotect
    wsDV.Unprotect

    lastRow = wsDV.Cells(wsDV.Rows.count, "F").End(xlUp).Row
    If lastRow < 2 Then
        ' No data in DV sheet, clear validation
        wsLogin.Range("B3").Validation.Delete
        GoTo CleanUp
    End If

    ' Set the range for data validation
    Set dvRange = wsDV.Range("F2:F" & lastRow)

    ' Update the data validation
    With wsLogin.Range("B3").Validation
        .Delete
        .Add Type:=xlValidateList, AlertStyle:=xlValidAlertStop, _
             Operator:=xlBetween, Formula1:="=" & dvRange.Address(External:=True)
        .InCellDropdown = True
    End With

    GoTo CleanUp

ErrorHandler:
    MsgBox "An error occurred while updating the Login dropdown: " & Err.Description, vbCritical, "Error"

CleanUp:
    ' Re-protect Login and DV sheets
    wsLogin.Protect UserInterfaceOnly:=True
    wsDV.Protect UserInterfaceOnly:=True

    ' Refresh the Login sheet to ensure changes are visible
    wsLogin.Calculate
End Sub

Private Function GetVeryHiddenSheet(sheetName As String) As Worksheet
    Dim ws As Worksheet
    For Each ws In ThisWorkbook.Worksheets
        If ws.Name = sheetName Then
            Set GetVeryHiddenSheet = ws
            Exit Function
        End If
    Next ws
End Function

Private Sub ClearNewUserFields(ws As Worksheet)
    Application.EnableEvents = False
    ws.Unprotect

    ' Clear specified form input fields
    ws.Range("D12,D14,D16,H6,H8,H10,H12,H14,H16").ClearContents
    ws.Range("D12").value = "New Timesheet Entry"

    ' Maintain protection settings
    ws.Cells.Locked = True
    ws.Range("D6,D8,D10").Locked = True
    ws.Range("D12,D14,E14,D16,H6,H8,H10,H12,H14,H16,AT1").Locked = False
    ws.Range("B3000:P" & ws.Rows.count).Locked = False ' Keep storage area unlocked

    ws.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    Application.EnableEvents = True
End Sub

Public Sub DeleteUserSheet()
    Dim ws As Worksheet
    Dim wsDV As Worksheet
    Dim wsLogin As Worksheet
    Dim userID As String
    Dim dvRow As Long

    ' Get the active sheet
    Set ws = ActiveSheet

    ' Check if the active sheet is a user sheet
    If ws.Name = "Login" Or ws.Name = "DV" Or ws.Name = "Form" Then
        MsgBox "This sheet cannot be deleted.", vbExclamation
        Exit Sub
    End If

    ' Confirm deletion
    If MsgBox("Are you sure you want to delete the sheet for user " & ws.Name & "?", vbYesNo + vbQuestion) = vbNo Then
        Exit Sub
    End If

    userID = ws.Name

    ' Delete the sheet
    Application.DisplayAlerts = False
    ws.Delete
    Application.DisplayAlerts = True

    ' Remove user from DV sheet
    Set wsDV = ThisWorkbook.Sheets("DV")
    dvRow = Application.Match(userID, wsDV.Columns("F"), 0)
    If Not IsError(dvRow) Then
        wsDV.Rows(dvRow).Delete
    End If

    ' Update Login dropdown
    UpdateLoginDropdown

    MsgBox "User sheet and data for " & userID & " have been deleted.", vbInformation
End Sub


sheet code===========================
Private Sub Worksheet_Change(ByVal Target As Range)
    Static isProcessing As Boolean
    If isProcessing Then Exit Sub

    isProcessing = True
    Application.EnableEvents = False


    ' Engagement ID requires Region (D16)
    If Not Intersect(Target, Me.Range("H6")) Is Nothing Then
        If Trim(Me.Range("D16").value) = "" Then
            MsgBox "Please select Region first.", vbExclamation, "Selection Required"
            Me.Range("H6").ClearContents
            Me.Range("D16").Select
            GoTo CleanUp
        End If
    End If

    ' Region changed: clear Engagement ID (H6)
    If Not Intersect(Target, Me.Range("D16")) Is Nothing Then
        If Trim(Me.Range("H6").value) <> "" Then
            Me.Unprotect
            Me.Range("H6").ClearContents
            Me.Protect UserInterfaceOnly:=True, AllowFiltering:=True
            MsgBox "Region changed. Engagement ID cleared.", vbInformation, "Field Cleared"
        End If
    End If

    ' ENHANCED: Timesheet Type Correction with Auto-Fill
    If Not Intersect(Target, Me.Range("D12")) Is Nothing Then
        If LCase$(Trim(Me.Range("D12").value)) = "timesheet entry correction" Then
            If Trim(Me.Range("D6").value) = "" Then
                MsgBox "Enterprise ID required for correction.", vbExclamation
                Me.Range("D12").value = "New Timesheet Entry"
                GoTo CleanUp
            End If

            Dim code As String
            code = InputBox("Enter Unique Code to correct:", "Correction Code Required")
            If code = "" Then
                MsgBox "Correction cancelled.", vbInformation
                Me.Range("D12").value = "New Timesheet Entry"
                GoTo CleanUp
            End If

            ' Store the code in a hidden cell
            Me.Unprotect
            Me.Range("AT1").value = code
            Me.Protect UserInterfaceOnly:=True, AllowFiltering:=True

            ' ENHANCED: Auto-fill from BOTH local storage AND database
            If AutoFillCorrectionData(Me, code, Me.Range("D6").value) Then
                MsgBox "Record found and loaded for correction!" & vbCrLf & _
                       "Unique Code: " & code & vbCrLf & _
                       "Modify any fields you want and click Submit.", vbInformation, "Correction Loaded"
            Else
                MsgBox "Record not found in local storage or database." & vbCrLf & _
                       "Please check the Unique Code and try again.", vbExclamation, "Record Not Found"
                Me.Range("D12").value = "New Timesheet Entry"
                Me.Unprotect
                Me.Range("AT1").ClearContents
                Me.Protect UserInterfaceOnly:=True, AllowFiltering:=True
            End If
        Else
            Me.Unprotect
            Me.Range("AT1").ClearContents
            Me.Protect UserInterfaceOnly:=True, AllowFiltering:=True
        End If
    End If

CleanUp:
    Application.EnableEvents = True
    isProcessing = False
End Sub

' ENHANCED: Auto-fill function that checks BOTH local and database
Private Function AutoFillCorrectionData(ws As Worksheet, code As String, entID As String) As Boolean
    Dim foundRow As Long
    AutoFillCorrectionData = False
    
    ' First, check local storage (rows 300+)
    foundRow = FindLocalRecordRow(ws, code, entID)
    If foundRow > 0 Then
        ' Auto-fill from local storage
        LoadDataFromLocalRow ws, foundRow
        AutoFillCorrectionData = True
        Exit Function
    End If
    
    ' If not found locally, check database
    Dim wsDB As Worksheet
    Set wsDB = ThisWorkbook.Sheets("Data base")
    foundRow = FindDatabaseRecordRow(wsDB, code, entID)
    If foundRow > 0 Then
        ' Auto-fill from database
        LoadDataFromDatabaseRow ws, wsDB, foundRow
        AutoFillCorrectionData = True
        Exit Function
    End If
End Function

Private Function FindLocalRecordRow(ws As Worksheet, code As String, entID As String) As Long
    Dim r As Long, lastRow As Long
    lastRow = ws.Cells(ws.Rows.count, "B").End(xlUp).Row
    For r = 3000 To lastRow
        If ws.Cells(r, 2).value = code And ws.Cells(r, 3).value = entID Then
            FindLocalRecordRow = r
            Exit Function
        End If
    Next r
    FindLocalRecordRow = 0
End Function

Private Function FindDatabaseRecordRow(wsDB As Worksheet, code As String, entID As String) As Long
    Dim r As Long, lastRow As Long
    lastRow = wsDB.Cells(wsDB.Rows.count, 1).End(xlUp).Row
    For r = 2 To lastRow
        If wsDB.Cells(r, 1).value = code And wsDB.Cells(r, 2).value = entID Then
            FindDatabaseRecordRow = r
            Exit Function
        End If
    Next r
    FindDatabaseRecordRow = 0
End Function

Private Sub LoadDataFromLocalRow(ws As Worksheet, sourceRow As Long)
    ' Load data from local storage row into form fields
    ws.Unprotect

    Dim combinedMonthWeek As String
    combinedMonthWeek = ws.Cells(sourceRow, 8).value ' Combined Month_Week

    ' Split the combined value
    If InStr(combinedMonthWeek, " : ") > 0 Then
        ws.Range("D14").value = Split(combinedMonthWeek, " : ")(0) ' Month
        ws.Range("E14").value = Split(combinedMonthWeek, " : ")(1) ' Week
    Else
        ws.Range("D14").value = combinedMonthWeek
        ws.Range("E14").value = ""
    End If

    ws.Range("D16").value = ws.Cells(sourceRow, 9).value ' Region
    ws.Range("H6").value = ws.Cells(sourceRow, 10).value ' Engagement ID
    ws.Range("H8").value = ws.Cells(sourceRow, 11).value ' Engagement Hours
    ws.Range("H10").value = ws.Cells(sourceRow, 12).value ' Team Name
    ws.Range("H12").value = ws.Cells(sourceRow, 13).value ' Non-Audit Name
    ws.Range("H14").value = ws.Cells(sourceRow, 14).value ' Non-Audit Hours
    ws.Range("H16").value = ws.Cells(sourceRow, 15).value ' Remarks

    ws.Protect UserInterfaceOnly:=True, AllowFiltering:=True
End Sub

Private Sub LoadDataFromDatabaseRow(ws As Worksheet, wsDB As Worksheet, dbRow As Long)
    ' Load data from database row into form fields
    ws.Unprotect

    Dim combinedMonthWeek As String
    combinedMonthWeek = wsDB.Cells(dbRow, 7).value ' Combined Month_Week

    ' Split the combined value
    If InStr(combinedMonthWeek, " : ") > 0 Then
        ws.Range("D14").value = Split(combinedMonthWeek, " : ")(0) ' Month
        ws.Range("E14").value = Split(combinedMonthWeek, " : ")(1) ' Week
    Else
        ws.Range("D14").value = combinedMonthWeek
        ws.Range("E14").value = ""
    End If

    ws.Range("D16").value = wsDB.Cells(dbRow, 8).value ' Region
    ws.Range("H6").value = wsDB.Cells(dbRow, 9).value ' Engagement ID
    ws.Range("H8").value = wsDB.Cells(dbRow, 10).value ' Engagement Hours
    ws.Range("H10").value = wsDB.Cells(dbRow, 11).value ' Team Name
    ws.Range("H12").value = wsDB.Cells(dbRow, 12).value ' Non-Audit Name
    ws.Range("H14").value = wsDB.Cells(dbRow, 13).value ' Non-Audit Hours
    ws.Range("H16").value = wsDB.Cells(dbRow, 14).value ' Remarks

    ws.Protect UserInterfaceOnly:=True, AllowFiltering:=True
End Sub


Private Sub Worksheet_Activate()
    If Me.Range("D6").value <> "" Then
        Me.Range("D8").Select
    End If
End Sub










Option Explicit

Private Sub Workbook_Open()
    Dim ws As Worksheet
    Dim activeUsers As Collection

    Application.ScreenUpdating = False

    ' Create a collection of sheets that are currently being edited
    Set activeUsers = New Collection
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" Then
            If IsSheetInUse(ws) Then
                activeUsers.Add ws.Name
            End If
        End If
    Next ws

    ' Hide all sheets except Login, Data base, and those being edited
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" Then
            If Not IsInCollection(activeUsers, ws.Name) Then
                ws.Visible = xlSheetVeryHidden
            End If
        End If
    Next ws

    Sheets("Login").Visible = xlSheetVisible
    Sheets("Login").Activate
 
' ====   Start the session timer
     'StartSessionTimer

    Application.ScreenUpdating = True
End Sub
' Helper function to check if a sheet is currently being edited
Private Function IsSheetInUse(ws As Worksheet) As Boolean
    On Error Resume Next
    IsSheetInUse = Not ws.Protection.AllowEditRanges Is Nothing
    On Error GoTo 0
End Function

' Helper function to check if a value is in a collection
Private Function IsInCollection(col As Collection, val As Variant) As Boolean
    Dim item As Variant
    For Each item In col
        If item = val Then
            IsInCollection = True
            Exit Function
        End If
    Next item
    IsInCollection = False
End Function


Private Sub Workbook_SheetActivate(ByVal Sh As Object)
    On Error Resume Next
    If Sh.Name = "Admin" Then
        Call UpdatePendingCounts
    End If
End Sub

Private Sub Workbook_SheetChange(ByVal Sh As Object, ByVal Target As Range)
    Const YEAR_CELL As String = "H1"
    Const MONTH_CELL As String = "D14"

    On Error GoTo ErrorHandler

    ' Debug: Check if the event is triggered
    Debug.Print "Sheet changed: " & Sh.Name & ", Cell: " & Target.Address


    ' Handle Year and Month changes
    If Not (Intersect(Target, Sh.Range(YEAR_CELL)) Is Nothing And _
            Intersect(Target, Sh.Range(MONTH_CELL)) Is Nothing) Then
        HandleYearMonthChange Sh, Target
    End If

    Exit Sub

ErrorHandler:
    Debug.Print "Error " & Err.Number & ": " & Err.Description & " in line " & Erl
    Application.EnableEvents = True
End Sub



Private Sub HandleYearMonthChange(Sh As Worksheet, Target As Range)
    Const YEAR_CELL As String = "H1"
    Const MONTH_CELL As String = "D14"
    Const WEEK_CELL As String = "E14"

    Dim selectedYear As Integer
    Dim selectedMonth As String
    Dim firstDayOfMonth As Date
    Dim lastDayOfMonth As Date
    Dim currentDate As Date
    Dim weekList As New Collection
    Dim weekString As String
    Dim weekArray() As String
    Dim i As Integer

    Application.EnableEvents = False

    ' Unprotect the sheet
    UnprotectSheet Sh

    ' Get the selected year and month
    selectedYear = Sh.Range(YEAR_CELL).value
    selectedMonth = Sh.Range(MONTH_CELL).value

    ' Validate inputs
    If selectedYear = 0 Or selectedMonth = "" Then
        Sh.Range(WEEK_CELL).value = ""
        If HasValidation(Sh.Range(WEEK_CELL)) Then
            Sh.Range(WEEK_CELL).Validation.Delete
        End If
        GoTo CleanUp
    End If

    ' Calculate first and last day of the selected month
    firstDayOfMonth = DateSerial(selectedYear, Month(selectedMonth & " 1"), 1)
    lastDayOfMonth = DateSerial(selectedYear, Month(selectedMonth & " 1") + 1, 0)

    ' Find all Mondays in the month
    currentDate = firstDayOfMonth
    Do While currentDate <= lastDayOfMonth
        If Weekday(currentDate, vbMonday) = 1 Then
           weekString = "Week starting " & Format(currentDate, "mmmm d   yyyy")
            weekList.Add weekString
        End If
        currentDate = currentDate + 1
    Loop

    ' Create an array from the collection
    ReDim weekArray(1 To weekList.count)
    For i = 1 To weekList.count
        weekArray(i) = weekList(i)
    Next i

    ' Remove old validation if it exists
    If HasValidation(Sh.Range(WEEK_CELL)) Then
        Sh.Range(WEEK_CELL).Validation.Delete
    End If

    ' Add new validation
    Sh.Range(WEEK_CELL).Validation.Add _
        Type:=xlValidateList, _
        AlertStyle:=xlValidAlertStop, _
        Formula1:=Join(weekArray, ",")

    ' Clear any old value
    Sh.Range(WEEK_CELL).value = ""

CleanUp:
    ' Protect the sheet again
    ProtectSheet Sh
    Application.EnableEvents = True
End Sub

Private Sub Workbook_BeforeClose(Cancel As Boolean)
   ' Stop the session timer
     ' StopSessionTimer
Dim userName As String
    Dim ws As Worksheet

    ' Get the current user's name
    userName = Environ("USERNAME")

    ' Try to find the sheet that matches the user's name
    For Each ws In ThisWorkbook.Worksheets
        If LCase(ws.Name) = LCase(userName) Then
            ' If the sheet is found and not already hidden, hide it
            If Not ws.Visible = xlSheetHidden Then
                ws.Visible = xlSheetHidden
            End If
            Exit For
        End If
    Next ws

    ' If the sheet doesn't exist, do nothing (no error handling needed)



End Sub







Private Function HasValidation(rng As Range) As Boolean
    On Error Resume Next
    HasValidation = (rng.Validation.Type <> xlValidateInputOnly)
    On Error GoTo 0
End Function

Private Sub UnprotectSheet(ws As Worksheet)
    On Error Resume Next
    ws.Unprotect
    On Error GoTo 0
End Sub

Private Sub ProtectSheet(ws As Worksheet)
    On Error Resume Next
    ws.Protect UserInterfaceOnly:=True
    On Error GoTo 0
End Sub
' Placeholder for UpdatePendingCounts subroutine
Private Sub UpdatePendingCounts()
    ' Add your implementation here
    Debug.Print "UpdatePendingCounts called"
End Sub

NEW CODE+++++++++++++++++++++==============================

' ==================== MAIN MODULE ====================
Option Explicit

' Global variable to track correction mode
Public isCorrectionMode As Boolean

' ==================== NEW LOGIN FUNCTION ====================
Public Sub LoginUserFromForm(entID As String)
    ' Form-based login - optimized for new structure
    Dim wsUser As Worksheet
    
    On Error Resume Next
    Set wsUser = Sheets(entID)
    On Error GoTo 0
    
    If wsUser Is Nothing Then
        MsgBox "User sheet not found for ID: " & entID, vbExclamation
        Exit Sub
    End If
    
    ' Reset correction mode if any
    isCorrectionMode = False
    
    ' Show and setup user sheet
    wsUser.Visible = xlSheetVisible
    wsUser.Unprotect
    wsUser.Range("W6").Value = entID
    wsUser.Range("W6").Locked = True
    
    ' Set protection with FIXED ranges
    wsUser.Cells.Locked = True
    wsUser.Range("F2,W7").Locked = True
    wsUser.Range("C6,E6,H6,B10:J14").Locked = False
    wsUser.Range("B3000:T3200").Locked = False  ' FIXED RANGE
    
    wsUser.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    wsUser.Activate
    wsUser.Range("C6").Select
    ActiveWindow.Zoom = 80
    
    MsgBox "Welcome, " & Application.userName & "!" & vbNewLine & _
           "ID *" & entID & "* logged in successfully.", vbInformation
End Sub



' ==================== SUBMIT TIMESHEET (WITH UPDATED CORRECTION LOGIC) ====================
Public Sub SubmitTimesheet()
    On Error GoTo ErrorHandler

    Dim wsForm As Worksheet, wsDB As Worksheet
    Dim nextRow As Long, recordCount As Long
    Dim timesheetType As String, enterpriseID As String
    Dim employeeName As String, employeeEmail As String, monthName As String, weekName As String, teamName As String
    Dim submittedBy As String
    Dim i As Integer
    Dim auditCount As Integer, nonAuditCount As Integer
    Dim uniqueCode As String

    Set wsForm = ActiveSheet
    Set wsDB = ThisWorkbook.Sheets("Data base")

    ' Gather basic form values
    enterpriseID = Trim(wsForm.Range("W6").Value)
    employeeName = Trim(wsForm.Range("F2").Value)
    employeeEmail = Trim(wsForm.Range("W7").Value)

    ' Determine if this is a correction based on correction mode
    If isCorrectionMode Then
        timesheetType = "Timesheet Correction"
        ' For corrections, find existing unique code
        uniqueCode = FindExistingUniqueCode(wsForm, enterpriseID, wsForm.Range("E6").Value)
        If uniqueCode = "" Then
            ' Generate new code if not found (shouldn't happen)
            uniqueCode = GetNextLocalCode(wsForm)
        End If
    Else
        timesheetType = "New Timesheet Entry"
        uniqueCode = GetNextLocalCode(wsForm)
    End If

    monthName = Trim(wsForm.Range("C6").Value)
    weekName = Trim(wsForm.Range("E6").Value)
    teamName = Trim(wsForm.Range("H6").Value)
    submittedBy = Application.userName

    ' Basic validations
    If Not ValidateBasicFields(wsForm, enterpriseID, monthName, weekName, teamName) Then GoTo CleanUp

    ' Validate hours columns (E and I) for integer values
    If Not ValidateHoursColumns(wsForm) Then GoTo CleanUp

    ' Count and validate engagement records (rows 10-14)
    recordCount = CountValidEngagementRecords(wsForm, auditCount, nonAuditCount)
    If recordCount = 0 Then
        MsgBox "Please fill at least one engagement record (either Audit or Non-Audit).", vbExclamation, "No Records Found"
        GoTo CleanUp
    End If

    ' Validate individual rows for completeness
    If Not ValidateEngagementRows(wsForm) Then GoTo CleanUp

    ' Check for duplicates ONLY if NOT in correction mode
    If Not isCorrectionMode Then
        If HasDuplicateEntries(wsForm, wsDB, enterpriseID, monthName, weekName, teamName) Then GoTo CleanUp
    End If

    Application.EnableEvents = False
    Application.ScreenUpdating = False
    wsForm.Unprotect

    ' Confirmation with proper formatting
    Dim confirmMsg As String
    If isCorrectionMode Then
        confirmMsg = "You are Submitting Correction For " & auditCount & " Audit and " & nonAuditCount & " Non-Audit Engagements" & vbCrLf & _
                    "Week: " & weekName & vbCrLf & _
                    "Unique Code: " & uniqueCode & vbCrLf & vbCrLf & _
                    "Do you want to proceed with the corrections?"
    Else
        confirmMsg = "You are Recording " & auditCount & " Audit and " & nonAuditCount & " Non-Audit Engagements" & vbCrLf & _
                    "Week: " & weekName & vbCrLf & _
                    "Unique Code: " & uniqueCode & vbCrLf & vbCrLf & _
                    "Do you want to proceed with the submission?"
    End If

    If MsgBox(confirmMsg, vbQuestion + vbYesNo, "Confirm Submission") = vbNo Then
        MsgBox "Submission cancelled.", vbInformation
        GoTo CleanUp
    End If

    ' ==================== FIXED CORRECTION LOGIC - UPDATE IN PLACE ====================
    If isCorrectionMode Then
        ' Find and update existing records
        Dim foundRow As Long
        foundRow = FindRowByUniqueCode(wsForm, uniqueCode, enterpriseID)
        
        If foundRow > 0 Then
            ' Update existing record
            UpdateLocalRow wsForm, foundRow, enterpriseID, employeeName, _
                          employeeEmail, timesheetType, monthName, weekName, _
                          teamName, submittedBy
        Else
            ' If not found, create new (shouldn't happen)
            For i = 10 To 14
                If IsEngagementRowValid(wsForm, i) Then
                    nextRow = GetNextStorageRow(wsForm)
                    WriteEngagementRecord wsForm, nextRow, enterpriseID, employeeName, _
                                         employeeEmail, timesheetType, monthName, weekName, _
                                         teamName, i, submittedBy, uniqueCode
                End If
            Next i
        End If
    Else
        ' New entry - write to storage
        For i = 10 To 14
            If IsEngagementRowValid(wsForm, i) Then
                nextRow = GetNextStorageRow(wsForm)
                WriteEngagementRecord wsForm, nextRow, enterpriseID, employeeName, _
                                     employeeEmail, timesheetType, monthName, weekName, _
                                     teamName, i, submittedBy, uniqueCode
            End If
        Next i
    End If

    ThisWorkbook.Save

    ' Success message with proper formatting
    Dim successMsg As String
    If Not isCorrectionMode Then
        successMsg = "Your Timesheet has been Successfully Submitted with " & auditCount & " Audit and " & nonAuditCount & " Non-Audit Engagements" & vbCrLf & _
                    "Week starting: " & weekName & vbCrLf & _
                    "Enterprise ID: " & enterpriseID & vbCrLf & _
                    "Unique Code: " & uniqueCode & vbCrLf & vbCrLf & _
                    "Records will be synced to database by Admin."
    Else
        successMsg = "Your Timesheet Correction has been Successfully Submitted!" & vbCrLf & _
                    auditCount & " Audit and " & nonAuditCount & " Non-Audit Engagements" & vbCrLf & _
                    "Week starting: " & weekName & vbCrLf & _
                    "Unique Code: " & uniqueCode
    End If

    MsgBox successMsg, vbInformation, "Submission Complete"

    ' Reset correction mode and form
    isCorrectionMode = False
    ResetFormInputsOnly wsForm
    GoTo CleanUp

ErrorHandler:
    MsgBox "ERROR in SubmitTimesheet:" & vbCrLf & _
           "Error: " & Err.Description & vbCrLf & _
           "Number: " & Err.Number, vbCritical, "System Error"

CleanUp:
    On Error Resume Next
    wsForm.Cells.Locked = True
    wsForm.Range("F2,W7").Locked = True
    wsForm.Range("C6,E6,H6,B10:J14").Locked = False
    wsForm.Range("B3000:T3200").Locked = False  ' FIXED RANGE
    wsForm.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Call UpdatePendingCounts
    wsForm.Activate
End Sub

' ==================== HELPER FUNCTIONS FOR FIXED RANGES ====================
Private Function GetNextStorageRow(ws As Worksheet) As Long
    ' Find next available row in fixed storage area (3000-3200)
    Dim r As Long
    For r = 3000 To 3200
        If ws.Cells(r, 2).Value = "" Then
            GetNextStorageRow = r
            Exit Function
        End If
    Next r
    ' If all rows are full, use the first one (overwrite oldest)
    GetNextStorageRow = 3000
End Function

Private Sub UpdateLocalRow(ws As Worksheet, rowNum As Long, enterpriseID As String, _
                          employeeName As String, employeeEmail As String, timesheetType As String, _
                          monthName As String, weekName As String, teamName As String, _
                          submittedBy As String)
    ' Update existing record in place
    ' Note: This updates the entire row, you might want to update only specific columns
    ' based on which engagement rows were filled
    
    With ws
        .Cells(rowNum, 2).Value = enterpriseID
        .Cells(rowNum, 3).Value = employeeName
        .Cells(rowNum, 4).Value = employeeEmail
        .Cells(rowNum, 5).Value = Format(Now, "yyyy-mm-dd hh:mm:ss")
        .Cells(rowNum, 6).Value = timesheetType
        .Cells(rowNum, 7).Value = monthName
        .Cells(rowNum, 8).Value = weekName
        .Cells(rowNum, 9).Value = teamName
        .Cells(rowNum, 18).Value = submittedBy
        
        ' Font color to white (hidden)
        .Range(.Cells(rowNum, 2), .Cells(rowNum, 18)).Font.Color = RGB(255, 255, 255)
    End With
End Sub

Private Function FindRowByUniqueCode(ws As Worksheet, uniqueCode As String, enterpriseID As String) As Long
    Dim r As Long
    For r = 3000 To 3200
        If ws.Cells(r, 2).Value = enterpriseID And ws.Cells(r, 2).Value = uniqueCode Then
            FindRowByUniqueCode = r
            Exit Function
        End If
    Next r
    FindRowByUniqueCode = 0
End Function

Private Function FindExistingUniqueCode(ws As Worksheet, enterpriseID As String, weekName As String) As String
    Dim r As Long
    For r = 3000 To 3200
        If ws.Cells(r, 2).Value = enterpriseID And ws.Cells(r, 8).Value = weekName Then
            FindExistingUniqueCode = ws.Cells(r, 2).Value ' Assuming column B has unique code
            Exit Function
        End If
    Next r
    FindExistingUniqueCode = ""
End Function

Private Function GetNextLocalCode(ws As Worksheet) As String
    Dim maxCode As Long
    Dim r As Long
    
    maxCode = 0
    For r = 3000 To 3200
        If IsNumeric(ws.Cells(r, 2).Value) And ws.Cells(r, 2).Value <> "" Then
            If ws.Cells(r, 2).Value > maxCode Then
                maxCode = ws.Cells(r, 2).Value
            End If
        End If
    Next r
    
    GetNextLocalCode = CStr(maxCode + 1)
End Function

' ==================== ORIGINAL HELPER FUNCTIONS (UPDATED WITH FIXED RANGES) ====================
Private Function ValidateHoursColumns(ws As Worksheet) As Boolean
    Dim i As Integer
    Dim cellValue As String
    Dim numValue As Double

    ValidateHoursColumns = True

    ' Check rows 10-14 for hours validation
    For i = 10 To 14
        ' Check Audit Hours (Column E)
        cellValue = Trim(CStr(ws.Cells(i, 5).Value))
        If cellValue <> "" Then
            If Not IsNumeric(cellValue) Then
                MsgBox "Row " & i & ": Audit Hours (Column E) must be a valid number between 0-300.", vbExclamation, "Invalid Hours Entry"
                ws.Cells(i, 5).Select
                ValidateHoursColumns = False
                Exit Function
            End If

            numValue = CDbl(cellValue)
            If numValue <> Int(numValue) Or numValue < 0 Or numValue > 300 Then
                MsgBox "Row " & i & ": Audit Hours (Column E) must be a whole number between 0-300.", vbExclamation, "Invalid Hours Entry"
                ws.Cells(i, 5).Select
                ValidateHoursColumns = False
                Exit Function
            End If
        End If

        ' Check Non-Audit Hours (Column I)
        cellValue = Trim(CStr(ws.Cells(i, 9).Value))
        If cellValue <> "" Then
            If Not IsNumeric(cellValue) Then
                MsgBox "Row " & i & ": Non-Audit Hours (Column I) must be a valid number between 0-300.", vbExclamation, "Invalid Hours Entry"
                ws.Cells(i, 9).Select
                ValidateHoursColumns = False
                Exit Function
            End If

            numValue = CDbl(cellValue)
            If numValue <> Int(numValue) Or numValue < 0 Or numValue > 300 Then
                MsgBox "Row " & i & ": Non-Audit Hours (Column I) must be a whole number between 0-300.", vbExclamation, "Invalid Hours Entry"
                ws.Cells(i, 9).Select
                ValidateHoursColumns = False
                Exit Function
            End If
        End If
    Next i
End Function

Private Function CountValidEngagementRecords(ws As Worksheet, ByRef auditCount As Integer, ByRef nonAuditCount As Integer) As Integer
    Dim Count As Integer, i As Integer
    Count = 0
    auditCount = 0
    nonAuditCount = 0

    For i = 10 To 14
        If IsEngagementRowValid(ws, i) Then
            Count = Count + 1
            ' Count audit and non-audit separately
            If Len(Trim(CStr(ws.Cells(i, 3).Value))) > 0 Then ' Audit Engagement ID exists
                auditCount = auditCount + 1
            End If
            If Len(Trim(CStr(ws.Cells(i, 8).Value))) > 0 Then ' Non-Audit Engagement exists
                nonAuditCount = nonAuditCount + 1
            End If
        End If
    Next i

    CountValidEngagementRecords = Count
End Function

Private Function IsEngagementRowValid(ws As Worksheet, rowNum As Integer) As Boolean
    Dim hasAuditComplete As Boolean, hasNonAuditComplete As Boolean
    Dim auditFieldsFilled As Boolean, nonAuditFieldsFilled As Boolean

    ' Check if any audit engagement fields are filled
    auditFieldsFilled = (Len(Trim(CStr(ws.Cells(rowNum, 2).Value))) > 0 Or _
                        Len(Trim(CStr(ws.Cells(rowNum, 3).Value))) > 0 Or _
                        Len(Trim(CStr(ws.Cells(rowNum, 4).Value))) > 0 Or _
                        Len(Trim(CStr(ws.Cells(rowNum, 5).Value))) > 0 Or _
                        Len(Trim(CStr(ws.Cells(rowNum, 6).Value))) > 0)

    ' Check if any non-audit engagement fields are filled
    nonAuditFieldsFilled = (Len(Trim(CStr(ws.Cells(rowNum, 8).Value))) > 0 Or _
                           Len(Trim(CStr(ws.Cells(rowNum, 9).Value))) > 0 Or _
                           Len(Trim(CStr(ws.Cells(rowNum, 10).Value))) > 0)

    ' If no fields are filled, row is not valid for processing
    If Not (auditFieldsFilled Or nonAuditFieldsFilled) Then
        IsEngagementRowValid = False
        Exit Function
    End If

    ' Check if audit engagement has all required fields
    If auditFieldsFilled Then
        hasAuditComplete = (Len(Trim(CStr(ws.Cells(rowNum, 2).Value))) > 0 And _
                           Len(Trim(CStr(ws.Cells(rowNum, 3).Value))) > 0 And _
                           Len(Trim(CStr(ws.Cells(rowNum, 4).Value))) > 0 And _
                           Len(Trim(CStr(ws.Cells(rowNum, 5).Value))) > 0)
    End If

    ' Check if non-audit engagement has minimum required fields
    If nonAuditFieldsFilled Then
        hasNonAuditComplete = (Len(Trim(CStr(ws.Cells(rowNum, 8).Value))) > 0 And _
                              Len(Trim(CStr(ws.Cells(rowNum, 9).Value))) > 0)
    End If

    ' Row is valid if either audit is complete OR non-audit is complete
    IsEngagementRowValid = (hasAuditComplete Or hasNonAuditComplete)
End Function

Private Function ValidateEngagementRows(ws As Worksheet) As Boolean
    Dim i As Integer
    Dim hasAuditComplete As Boolean, hasNonAuditComplete As Boolean
    Dim auditFieldsFilled As Boolean, nonAuditFieldsFilled As Boolean

    ValidateEngagementRows = True

    For i = 10 To 14
        auditFieldsFilled = (Len(Trim(CStr(ws.Cells(i, 2).Value))) > 0 Or _
                            Len(Trim(CStr(ws.Cells(i, 3).Value))) > 0 Or _
                            Len(Trim(CStr(ws.Cells(i, 4).Value))) > 0 Or _
                            Len(Trim(CStr(ws.Cells(i, 5).Value))) > 0 Or _
                            Len(Trim(CStr(ws.Cells(i, 6).Value))) > 0)

        nonAuditFieldsFilled = (Len(Trim(CStr(ws.Cells(i, 8).Value))) > 0 Or _
                               Len(Trim(CStr(ws.Cells(i, 9).Value))) > 0 Or _
                               Len(Trim(CStr(ws.Cells(i, 10).Value))) > 0)

        ' If any fields are filled, validate completeness
        If auditFieldsFilled Or nonAuditFieldsFilled Then

            ' Check audit engagement completeness
            If auditFieldsFilled Then
                hasAuditComplete = (Len(Trim(CStr(ws.Cells(i, 2).Value))) > 0 And _
                                   Len(Trim(CStr(ws.Cells(i, 3).Value))) > 0 And _
                                   Len(Trim(CStr(ws.Cells(i, 4).Value))) > 0 And _
                                   Len(Trim(CStr(ws.Cells(i, 5).Value))) > 0)
            Else
                hasAuditComplete = False
            End If

            ' Check non-audit engagement completeness
            If nonAuditFieldsFilled Then
                hasNonAuditComplete = (Len(Trim(CStr(ws.Cells(i, 8).Value))) > 0 And _
                                      Len(Trim(CStr(ws.Cells(i, 9).Value))) > 0)
            Else
                hasNonAuditComplete = False
            End If

            ' If audit fields are filled but incomplete
            If auditFieldsFilled And Not hasAuditComplete Then
                MsgBox "Row " & i & ": Please complete all required Audit Engagement fields:" & vbCrLf & _
                       "- Region (B" & i & ")" & vbCrLf & _
                       "- Engagement ID (C" & i & ")" & vbCrLf & _
                       "- Engagement Activity (D" & i & ")" & vbCrLf & _
                       "- Hours (E" & i & ")", _
                       vbExclamation, "Incomplete Audit Entry"
                ws.Cells(i, 2).Select
                ValidateEngagementRows = False
                Exit Function
            End If

            ' If non-audit fields are filled but incomplete
            If nonAuditFieldsFilled And Not hasNonAuditComplete Then
                MsgBox "Row " & i & ": Please complete all required Non-Audit Engagement fields:" & vbCrLf & _
                       "- Non-Audit Engagement (H" & i & ")" & vbCrLf & _
                       "- Hours (I" & i & ")", _
                       vbExclamation, "Incomplete Non-Audit Entry"
                ws.Cells(i, 8).Select
                ValidateEngagementRows = False
                Exit Function
            End If

            ' At least one type must be complete for the row to be valid
            If Not (hasAuditComplete Or hasNonAuditComplete) Then
                MsgBox "Row " & i & ": Please complete either Audit OR Non-Audit engagement fields completely.", _
                       vbExclamation, "Incomplete Entry"
                ValidateEngagementRows = False
                Exit Function
            End If
        End If
    Next i
End Function

Private Function HasDuplicateEntries(wsForm As Worksheet, wsDB As Worksheet, enterpriseID As String, _
                                   monthName As String, weekName As String, teamName As String) As Boolean
    Dim i As Integer
    HasDuplicateEntries = False

    For i = 10 To 14
        If IsEngagementRowValid(wsForm, i) Then
            Dim engagementID As String
            Dim region As String

            ' Get engagement ID (audit or non-audit)
            If Len(Trim(CStr(wsForm.Cells(i, 3).Value))) > 0 Then
                engagementID = Trim(CStr(wsForm.Cells(i, 3).Value))
                region = Trim(CStr(wsForm.Cells(i, 2).Value))
            Else
                engagementID = Trim(CStr(wsForm.Cells(i, 8).Value))
                region = ""
            End If

            If CheckDuplicateInLocal(wsForm, enterpriseID, engagementID, monthName, weekName, region, teamName) Or _
               CheckDuplicateInDB(wsDB, enterpriseID, engagementID, monthName, weekName, region, teamName) Then

                Dim response As VbMsgBoxResult
                response = MsgBox("Duplicate entry found for:" & vbCrLf & _
                                "Week: " & weekName & vbCrLf & _
                                "Team: " & teamName & vbCrLf & _
                                "Engagement: " & engagementID & vbCrLf & _
                                "Region: " & region & vbCrLf & vbCrLf & _
                                "Do you want to make a correction instead?", _
                                vbYesNo + vbExclamation, "Duplicate Entry")

                If response = vbYes Then
                    MsgBox "Please use the 'View/Correction' button to make changes to existing entries.", vbInformation
                    HasDuplicateEntries = True
                    Exit Function
                Else
                    MsgBox "Submission cancelled. Please review your entries.", vbInformation
                    HasDuplicateEntries = True
                    Exit Function
                End If
            End If
        End If
    Next i
End Function

Private Function CheckDuplicateInLocal(ws As Worksheet, enterpriseID As String, engagementID As String, _
                                     monthName As String, weekName As String, region As String, teamName As String) As Boolean
    Dim r As Long

    For r = 3000 To 3200
        If ws.Cells(r, 2).Value = enterpriseID And _
           ws.Cells(r, 7).Value = monthName And _
           ws.Cells(r, 8).Value = weekName And _
           ws.Cells(r, 9).Value = teamName And _
           ((region <> "" And ws.Cells(r, 10).Value = region) Or region = "") And _
           (ws.Cells(r, 11).Value = engagementID Or ws.Cells(r, 15).Value = engagementID) Then
           CheckDuplicateInLocal = True
           Exit Function
        End If
    Next r
    CheckDuplicateInLocal = False
End Function

Private Function CheckDuplicateInDB(wsDB As Worksheet, enterpriseID As String, engagementID As String, _
                                  monthName As String, weekName As String, region As String, teamName As String) As Boolean
    Dim r As Long, lastRow As Long

    lastRow = wsDB.Cells(wsDB.Rows.Count, 1).End(xlUp).Row
    For r = 2 To lastRow
        If wsDB.Cells(r, 1).Value = enterpriseID And _
           wsDB.Cells(r, 6).Value = monthName And _
           wsDB.Cells(r, 7).Value = weekName And _
           wsDB.Cells(r, 8).Value = teamName And _
           ((region <> "" And wsDB.Cells(r, 9).Value = region) Or region = "") And _
           (wsDB.Cells(r, 10).Value = engagementID Or wsDB.Cells(r, 14).Value = engagementID) Then
           CheckDuplicateInDB = True
           Exit Function
        End If
    Next r
    CheckDuplicateInDB = False
End Function

Private Sub WriteEngagementRecord(ws As Worksheet, nextRow As Long, _
                                 enterpriseID As String, employeeName As String, employeeEmail As String, _
                                 timesheetType As String, monthName As String, weekName As String, _
                                 teamName As String, rowNum As Integer, submittedBy As String, uniqueCode As String)

    With ws
        .Cells(nextRow, 2).Value = uniqueCode                  ' Unique Code
        .Cells(nextRow, 3).Value = enterpriseID                ' Enterprise ID
        .Cells(nextRow, 4).Value = employeeName                ' Employee Name
        .Cells(nextRow, 5).Value = employeeEmail               ' Employee Email
        .Cells(nextRow, 6).Value = Format(Now, "yyyy-mm-dd hh:mm:ss") ' Date and time
        .Cells(nextRow, 7).Value = timesheetType               ' New Timesheet/Correction
        .Cells(nextRow, 8).Value = monthName                   ' Month
        .Cells(nextRow, 9).Value = weekName                    ' Week
        .Cells(nextRow, 10).Value = teamName                   ' Team Name
        .Cells(nextRow, 11).Value = .Cells(rowNum, 2).Value    ' Region
        .Cells(nextRow, 12).Value = .Cells(rowNum, 3).Value    ' Audit Engagement ID
        .Cells(nextRow, 13).Value = .Cells(rowNum, 4).Value    ' Engagement Activity
        .Cells(nextRow, 14).Value = .Cells(rowNum, 5).Value    ' Engagement Hours
        .Cells(nextRow, 15).Value = .Cells(rowNum, 6).Value    ' Remark 1
        .Cells(nextRow, 16).Value = .Cells(rowNum, 8).Value    ' Non-Audit Engagement
        .Cells(nextRow, 17).Value = .Cells(rowNum, 9).Value    ' Non-Audit Hours
        .Cells(nextRow, 18).Value = .Cells(rowNum, 10).Value   ' Remark 2
        .Cells(nextRow, 19).Value = submittedBy                ' User Submitted Record

        ' Set font color to white (hidden)
        .Range(.Cells(nextRow, 2), .Cells(nextRow, 19)).Font.Color = RGB(255, 255, 255)
    End With
End Sub

Public Sub ViewCorrection()
    Dim wsForm As Worksheet
    Set wsForm = ActiveSheet
    Dim weekName As String, entID As String

    weekName = Trim(wsForm.Range("E6").Value)
    entID = Trim(wsForm.Range("W6").Value)

    If weekName = "" Then
        MsgBox "Please select a week first before viewing/correcting entries.", vbExclamation, "Week Required"
        wsForm.Range("E6").Select
        Exit Sub
    End If

    ' Set correction mode
    isCorrectionMode = True

    ' Clear the entry area first
    ClearEntryArea wsForm

    ' Load week data into the entry area
    LoadWeekDataToEntryArea wsForm, weekName, entID

    MsgBox "Week entries loaded in the timesheet area. You can now edit and submit corrections." & vbCrLf & _
           "Note: Duplicate checking is disabled in correction mode.", vbInformation, "View/Correction Mode"
End Sub

Private Sub ClearEntryArea(ws As Worksheet)
    On Error Resume Next
    ws.Unprotect
    ' Clear the entry area (rows 10-14)
    ws.Range("B10:J14").ClearContents
    ws.Range("B10:J14").Interior.ColorIndex = xlNone

    ws.Cells.Locked = True
    ws.Range("F2,W7").Locked = True
    ws.Range("C6,E6,H6,B10:J14").Locked = False
    ws.Range("B3000:T3200").Locked = False  ' FIXED RANGE
    ws.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    On Error GoTo 0
End Sub

Private Sub LoadWeekDataToEntryArea(ws As Worksheet, weekName As String, entID As String)
    Dim r As Long
    Dim targetRow As Long
    
    targetRow = 10
    
    ' Search in local storage (from row 3000 to 3200)
    For r = 3000 To 3200
        If ws.Cells(r, 3).Value = entID And _
           ws.Cells(r, 9).Value = weekName And _
           targetRow <= 14 Then
            
            ' Copy data to entry area
            ws.Cells(targetRow, 2).Value = ws.Cells(r, 11).Value  ' Region
            ws.Cells(targetRow, 3).Value = ws.Cells(r, 12).Value  ' Audit Engagement
            ws.Cells(targetRow, 4).Value = ws.Cells(r, 13).Value  ' Engagement Activity
            ws.Cells(targetRow, 5).Value = ws.Cells(r, 14).Value  ' Hours
            ws.Cells(targetRow, 6).Value = ws.Cells(r, 15).Value  ' Remark 1
            ws.Cells(targetRow, 8).Value = ws.Cells(r, 16).Value  ' Non-Audit Engagement
            ws.Cells(targetRow, 9).Value = ws.Cells(r, 17).Value  ' Non-Audit Hours
            ws.Cells(targetRow, 10).Value = ws.Cells(r, 18).Value ' Remark 2
            
            targetRow = targetRow + 1
        End If
    Next r
    
    ' Also search in database
    Dim wsDB As Worksheet
    Set wsDB = ThisWorkbook.Sheets("Data base")
    Dim lastRow As Long
    lastRow = wsDB.Cells(wsDB.Rows.Count, 1).End(xlUp).Row
    
    For r = 2 To lastRow
        If wsDB.Cells(r, 1).Value = entID And _
           wsDB.Cells(r, 7).Value = weekName And _
           targetRow <= 14 Then
            
            ' Copy data to entry area
            ws.Cells(targetRow, 2).Value = wsDB.Cells(r, 9).Value   ' Region
            ws.Cells(targetRow, 3).Value = wsDB.Cells(r, 10).Value  ' Audit Engagement
            ws.Cells(targetRow, 4).Value = wsDB.Cells(r, 11).Value  ' Engagement Activity
            ws.Cells(targetRow, 5).Value = wsDB.Cells(r, 12).Value  ' Hours
            ws.Cells(targetRow, 6).Value = wsDB.Cells(r, 13).Value  ' Remark 1
            ws.Cells(targetRow, 8).Value = wsDB.Cells(r, 14).Value  ' Non-Audit Engagement
            ws.Cells(targetRow, 9).Value = wsDB.Cells(r, 15).Value  ' Non-Audit Hours
            ws.Cells(targetRow, 10).Value = wsDB.Cells(r, 16).Value ' Remark 2
            
            targetRow = targetRow + 1
        End If
    Next r
End Sub

' ==================== SYNC FUNCTION (UPDATED WITH FIXED RANGES) ====================
Public Sub SyncAllUserSheetsToDatabase()
    On Error GoTo ErrorHandler

    Dim pass As String
    pass = InputBox("Enter sync password:", "Admin Sync Required")
    If pass <> "123" Then
        MsgBox "Incorrect password. Access denied.", vbCritical, "Access Denied"
        Exit Sub
    End If

    Dim ws As Worksheet, wsDB As Worksheet, wsAdmin As Worksheet
    Dim r As Long, nextDBRow As Long
    Dim recordCount As Long, userCount As Long, deletedCount As Long

    recordCount = 0
    userCount = 0
    deletedCount = 0
    Set wsDB = ThisWorkbook.Sheets("Data base")
    Set wsAdmin = ThisWorkbook.Sheets("Admin")

    wsDB.Unprotect

    ' First, process deletions in the database
    Dim lastDBRow As Long
    lastDBRow = wsDB.Cells(wsDB.Rows.Count, 1).End(xlUp).Row
    For r = lastDBRow To 2 Step -1
        On Error Resume Next
        If wsDB.Cells(r, 16).Value = "Marked for Deletion" Then
            wsDB.Rows(r).Delete
            deletedCount = deletedCount + 1
        End If
        On Error GoTo ErrorHandler
    Next r

    ' Process each user sheet
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Data base" And ws.Name <> "Login" And ws.Name <> "Admin" And ws.Name <> "DV" Then
            Dim userRecords As Long: userRecords = 0
            For r = 3000 To 3200  ' FIXED RANGE
                If ws.Cells(r, 2).Value <> "" Then
                    On Error Resume Next
                    Dim isMarkedForDeletion As Boolean
                    isMarkedForDeletion = (ws.Cells(r, 18).Value = "Marked for Deletion")
                    On Error GoTo ErrorHandler

                    If Not isMarkedForDeletion Then
                        nextDBRow = wsDB.Cells(wsDB.Rows.Count, 1).End(xlUp).Row + 1
                        wsDB.Cells(nextDBRow, 1).Resize(1, 17).Value = ws.Cells(r, 2).Resize(1, 17).Value
                        recordCount = recordCount + 1
                        userRecords = userRecords + 1
                    Else
                        deletedCount = deletedCount + 1
                    End If
                End If
            Next r

            If userRecords > 0 Or deletedCount > 0 Then
                On Error Resume Next
                ws.Unprotect
                On Error GoTo ErrorHandler

                ' Clear local storage within fixed range
                ws.Range("B3000:S3200").ClearContents  ' FIXED RANGE
                ws.Range("B3000:S3200").Interior.ColorIndex = xlNone
                userCount = userCount + 1

                On Error Resume Next
                ws.Cells.Locked = True
                ws.Range("F2,W7").Locked = True
                ws.Range("C6,E6,H6,B10:J15").Locked = False
                ws.Range("B3000:S3200").Locked = False  ' FIXED RANGE
                ws.Protect UserInterfaceOnly:=True, AllowFiltering:=True
                On Error GoTo ErrorHandler
            End If
        End If
    Next ws

    wsDB.Protect UserInterfaceOnly:=True

    ' Update sync timestamp
    wsAdmin.Range("G5").Value = Format(Now, "yyyy-mm-dd hh:mm:ss")

    ThisWorkbook.Save

    MsgBox "SYNC COMPLETED!" & vbCrLf & _
           "Users processed: " & userCount & vbCrLf & _
           "Records synced: " & recordCount & vbCrLf & _
           "Records deleted: " & deletedCount & vbCrLf & _
           "All local buffers cleared." & vbCrLf & _
           "Last sync: " & Format(Now, "yyyy-mm-dd hh:mm:ss"), vbInformation, "Sync Complete"

    Call UpdatePendingCounts
    Call LogoutAllUserSheets
    Exit Sub

ErrorHandler:
    MsgBox "An error occurred: " & Err.Description, vbCritical, "Error"
    On Error Resume Next
    wsDB.Protect UserInterfaceOnly:=True
    ThisWorkbook.Save
End Sub

Private Function ValidateBasicFields(wsForm As Worksheet, enterpriseID As String, monthName As String, weekName As String, teamName As String) As Boolean
    ValidateBasicFields = True
    If enterpriseID = "" Then
        MsgBox "Enterprise ID is required.", vbExclamation: ValidateBasicFields = False: Exit Function
    End If
    If monthName = "" Then
        MsgBox "Please select Month.", vbExclamation: ValidateBasicFields = False: wsForm.Range("C6").Select: Exit Function
    End If
    If weekName = "" Then
        MsgBox "Please select Week", vbExclamation: ValidateBasicFields = False: wsForm.Range("E6").Select: Exit Function
    End If
    If teamName = "" Then
        MsgBox "Please select Your Team.", vbExclamation: ValidateBasicFields = False: wsForm.Range("H6").Select: Exit Function
    End If
End Function

Private Sub ResetFormInputsOnly(f As Worksheet)
    Application.EnableEvents = False
    f.Unprotect

    ' Reset correction mode
    isCorrectionMode = False

    ' Clear engagement data (rows 10-14) and basic selections
    f.Range("B10:J14").ClearContents
    f.Range("B10:J14").Interior.ColorIndex = xlNone
    f.Range("C6,E6,H6").ClearContents

    ' Set proper protection with FIXED RANGES
    f.Cells.Locked = True
    f.Range("F2,W7").Locked = True
    f.Range("C6,E6,H6,B10:J14").Locked = False
    f.Range("B3000:T3200").Locked = False  ' FIXED RANGE

    f.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    Application.EnableEvents = True
End Sub

Public Sub LogoutUser()
    Dim response As VbMsgBoxResult
    response = MsgBox("Are you sure you want to logout?" & vbCrLf & _
                     "This will hide your sheet.", vbYesNo + vbQuestion, "Confirm Logout")

    If response = vbYes Then
        isCorrectionMode = False
        ActiveSheet.Visible = xlSheetVeryHidden
        Sheets("Admin").Activate
       
        Sheets("Admin").Range("F24").Select
        MsgBox "Logged out successfully. Please close this Excel file.", vbInformation
    End If
End Sub

Public Sub UpdatePendingCounts()
    Dim ws As Worksheet
    Dim totalPending As Long
    Dim userCount As Long
    Dim sheetPending As Long

    totalPending = 0
    userCount = 0

    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" And ws.Name <> "DV" And ws.Name <> "Admin" Then
            sheetPending = 0
            Dim r As Long
            For r = 3000 To 3200  ' FIXED RANGE CHECKING
                If ws.Cells(r, 2).Value <> "" Then
                    sheetPending = sheetPending + 1
                End If
            Next r
            
            If sheetPending > 0 Then
                totalPending = totalPending + sheetPending
                userCount = userCount + 1
            End If
        End If
    Next ws

    With ThisWorkbook.Sheets("Admin")
        .Range("G3").Value = totalPending
        .Range("G4").Value = userCount
    End With
End Sub

Public Sub LogoutAllUserSheets()
    Dim ws As Worksheet, Count As Long
    Count = 0

    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" And ws.Name <> "Admin" Then
            ws.Visible = xlSheetVeryHidden
            Count = Count + 1
        End If
    Next ws

    Sheets("Admin").Activate
End Sub

Public Sub ShowAllUserSheets()
    If InputBox("Enter admin password:") <> "123" Then
        MsgBox "Access denied": Exit Sub
    End If

    Dim ws As Worksheet, Count As Long
    Count = 0

    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" And ws.Name <> "Admin" Then
            ws.Visible = xlSheetVisible
            Count = Count + 1
        End If
    Next ws

    MsgBox Count & " user sheets are now visible.", vbInformation
End Sub

Public Sub HideAllUserSheets()
    If InputBox("Enter admin password:") <> "123" Then
        MsgBox "Access denied": Exit Sub
    End If

    Dim ws As Worksheet, Count As Long
    Count = 0

    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" And ws.Name <> "Admin" Then
            ws.Visible = xlSheetVeryHidden
            Count = Count + 1
        End If
    Next ws

    Sheets("Login").Activate
    MsgBox Count & " user sheets have been hidden.", vbInformation
End Sub

Public Sub OpenTimesheetCorrectionForm()
    On Error GoTo ErrorHandler

    If Trim(ActiveSheet.Range("W6").Value) = "" Then
        MsgBox "Please login first. Enterprise ID not found in cell W6.", vbExclamation, "Login Required"
        Exit Sub
    End If

    Dim correctionForm As UserFormDE
    Set correctionForm = New UserFormDE

    correctionForm.LoadEmployeeName

    correctionForm.Show

    Exit Sub

ErrorHandler:
    MsgBox "Error opening correction form: " & Err.Description, vbCritical, "Error"
    On Error Resume Next
    Set correctionForm = Nothing
End Sub

Public Sub ToggleMyDatabaseRecords()
    Dim wsF As Worksheet, wsDB As Worksheet
    Dim entID As String, i As Long, lastRow As Long, outRow As Long
    Dim startCell As Range, tblArea As Range
    Dim isDataPresent As Boolean

    Set wsF = ActiveSheet
    Set wsDB = ThisWorkbook.Sheets("Data base")
    Set startCell = wsF.Range("B25")
    Set tblArea = wsF.Range("B25:S297")

    entID = Trim(wsF.Range("W6").Value)
    If entID = "" Then
        MsgBox "Please verify Enterprise ID is populated.", vbExclamation
        Exit Sub
    End If

    On Error Resume Next
    wsF.Unprotect
    On Error GoTo 0

    isDataPresent = WorksheetFunction.CountA(tblArea.Offset(1)) > 0

    If isDataPresent Then
        tblArea.Offset(1).ClearContents
        tblArea.Offset(1).ClearFormats
        tblArea.Offset(1).Interior.ColorIndex = xlNone
        tblArea.Offset(1).Borders.LineStyle = xlNone
        startCell.Resize(1, 18).ClearContents
        startCell.Resize(1, 18).ClearFormats

        On Error Resume Next
        wsF.Cells.Locked = True
        wsF.Range("F2,W7").Locked = True
        wsF.Range("C6,E6,H6,B10:J15").Locked = False
        wsF.Range("B3000:T3200").Locked = False  ' FIXED RANGE
        wsF.Protect UserInterfaceOnly:=True, AllowFiltering:=True
        On Error GoTo 0
        MsgBox "Your past timesheet records have been hidden. Please click again to show them", vbInformation, "Toggle Complete"
        Exit Sub
    End If

    ' Headers
    startCell.Resize(1, 18).Value = Array("Unique Code", "Enterprise ID", "Employee Name", "Employee Email", _
        "Date and Time", "Type", "Month", "Week", "Team Name", "Region", "Audit Engagement", "Engagement Activity", _
        "Engagement Hr", "Remark 1", "Non-Audit Eng", "Non-Audit Hr", "Remark 2", "Submitted By")

    With startCell.Resize(1, 18)
        .Font.Bold = True
        .Interior.Color = RGB(200, 200, 200)
        .Borders.LineStyle = xlContinuous
        .HorizontalAlignment = xlCenter
    End With

    outRow = 1

    ' Show database records (synced)
    lastRow = wsDB.Cells(wsDB.Rows.Count, 1).End(xlUp).Row
    If lastRow >= 2 Then
        For i = 2 To lastRow
            If wsDB.Cells(i, 1).Value = entID Then
                startCell.Offset(outRow).Resize(1, 17).Value = wsDB.Range(wsDB.Cells(i, 1), wsDB.Cells(i, 17)).Value
                startCell.Offset(outRow, 17).Value = "Synced"
                startCell.Offset(outRow, 17).Interior.Color = RGB(200, 255, 200)
                outRow = outRow + 1
            End If
        Next i
    End If

    ' Show local pending records (within fixed range)
    For i = 3000 To 3200  ' FIXED RANGE
        If wsF.Cells(i, 2).Value <> "" And wsF.Cells(i, 3).Value = entID Then
            startCell.Offset(outRow).Resize(1, 17).Value = wsF.Range(wsF.Cells(i, 2), wsF.Cells(i, 18)).Value
            startCell.Offset(outRow, 17).Value = "Pending Sync"
            startCell.Offset(outRow, 17).Interior.Color = RGB(255, 255, 200)
            outRow = outRow + 1
        End If
    Next i

    ' Format data rows
    If outRow > 1 Then
        With startCell.Offset(1).Resize(outRow - 1, 18)
            .Borders.LineStyle = xlContinuous
            .HorizontalAlignment = xlLeft
        End With

        For i = 2 To outRow - 1 Step 2
            startCell.Offset(i).Resize(1, 18).Interior.Color = RGB(240, 240, 240)
        Next i

        MsgBox outRow - 1 & " Record(s) displayed for " & entID
    Else
        MsgBox "No records found for Enterprise ID: " & entID, vbInformation, "No Records"
    End If

    On Error Resume Next
    wsF.Cells.Locked = True
    wsF.Range("F2,W7").Locked = True
    wsF.Range("C6,E6,H6,B10:J15").Locked = False
    wsF.Range("B3000:T3200").Locked = False  ' FIXED RANGE
    wsF.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    On Error GoTo 0
End Sub

' ==================== ADMIN LOGIN FORM CALLER ====================
Public Sub ShowLoginForm()
    UserFormLOGIN.Show
End Sub

' ==================== USER MANAGEMENT FUNCTIONS (FIXED) ====================
Public Sub AddUsersFromTable()
    On Error GoTo ErrorHandler

    Dim userRange As Range
    Dim userRow As Range
    Dim enterpriseID As String, employeeName As String, employeeEmail As String
    Dim successCount As Integer, failCount As Integer
    Dim incompleteCount As Integer, existingCount As Integer
    Dim wsDV As Worksheet

    Application.EnableEvents = False
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    ' Use the predefined MUser range
    Set userRange = ThisWorkbook.Names("MUser").RefersToRange

    If userRange Is Nothing Then
        MsgBox "MUser range not found. Please check the Name Manager.", vbExclamation
        Exit Sub
    End If

    ' Initialize counters
    successCount = 0
    failCount = 0
    incompleteCount = 0
    existingCount = 0

    ' Unprotect DV sheet
    Set wsDV = ThisWorkbook.Sheets("DV")
    wsDV.Unprotect

    ' Loop through each row in the MUser range (skip header row)
    For Each userRow In userRange.Rows
        If userRow.Row > userRange.Row Then ' Skip header row
            enterpriseID = Trim(userRow.Cells(1, 1).Value)
            employeeName = Trim(userRow.Cells(1, 2).Value)
            employeeEmail = Trim(userRow.Cells(1, 3).Value)

            ' Only process rows where all fields are filled
            If enterpriseID <> "" And employeeName <> "" And employeeEmail <> "" Then
                ' Call AddNewUser function with error handling
                On Error Resume Next
                Call AddNewUser(enterpriseID, employeeName, employeeEmail)

                If Err.Number = 0 Then
                    successCount = successCount + 1
                ElseIf Err.Number = vbObjectError + 1 Then
                    existingCount = existingCount + 1
                Else
                    failCount = failCount + 1
                End If
                On Error GoTo ErrorHandler
            ElseIf enterpriseID <> "" Or employeeName <> "" Or employeeEmail <> "" Then
                ' If any field is filled but not all, count as incomplete
                incompleteCount = incompleteCount + 1
            End If
        End If
    Next userRow

    ' Update the Login dropdown after adding all users
    UpdateLoginDropdown

    ' Clear MUser range, leaving the header
    ClearMUserRange userRange

    ' Display results in a single message box
    Dim message As String
    Dim hasContent As Boolean
    hasContent = False

    message = "Process completed." & vbNewLine & vbNewLine

    If successCount > 0 Then
        message = message & "Users added successfully: " & successCount & vbNewLine
        hasContent = True
    End If

    If incompleteCount > 0 Then
        message = message & "Users with incomplete details: " & incompleteCount & vbNewLine
        hasContent = True
    End If

    If existingCount > 0 Then
        message = message & "Users already existing: " & existingCount & vbNewLine
        hasContent = True
    End If

    If failCount > 0 Then
        message = message & "Failed attempts: " & failCount & vbNewLine
        hasContent = True
    End If

    If Not hasContent Then
        message = message & "No users were processed."
    End If

    MsgBox message, vbInformation, "Add Users Result"

    GoTo CleanUp

ErrorHandler:
    MsgBox "An error occurred: " & Err.Description, vbCritical, "Error"

CleanUp:
    ' Re-protect DV sheet
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
End Sub

Private Sub ClearMUserRange(userRange As Range)
    ' Clear the MUser range, leaving the header
    If userRange.Rows.Count > 1 Then
        userRange.Offset(1).ClearContents
    End If
End Sub

Public Sub AddNewUser(enterpriseID As String, employeeName As String, employeeEmail As String)
    On Error GoTo ErrorHandler

    Dim wsLogin As Worksheet, wsForm As Worksheet, wsDV As Worksheet, wsNew As Worksheet
    Dim nextDVRow As Long

    ' === Check if user already exists ===
    If SheetExists(enterpriseID) Then
        Err.Raise vbObjectError + 1, , "User '" & enterpriseID & "' already exists!"
    End If

    ' === Get Template Form (even if very hidden) ===
    Set wsForm = GetVeryHiddenSheet("Form")
    If wsForm Is Nothing Then
        Err.Raise vbObjectError + 2, , "Template sheet 'Form' not found!"
    End If

    ' === Get DV sheet ===
    Set wsDV = ThisWorkbook.Sheets("DV")
    If wsDV Is Nothing Then
        Err.Raise vbObjectError + 3, , "DV sheet not found!"
    End If

    ' === Create new sheet by copying Form ===
    Dim originalVisibility As XlSheetVisibility
    originalVisibility = wsForm.Visible
    wsForm.Visible = xlSheetVisible  ' Temporarily make Form visible
    wsForm.Copy After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count)
    wsForm.Visible = originalVisibility  ' Set Form back to original visibility
    Set wsNew = ActiveSheet

    ' === Rename to Enterprise ID ===
    On Error Resume Next
    wsNew.Name = enterpriseID
    If Err.Number <> 0 Then
        Application.DisplayAlerts = False
        wsNew.Delete
        Application.DisplayAlerts = True
        Err.Raise vbObjectError + 4, , "Cannot rename sheet to '" & enterpriseID & "'. Please use a valid sheet name."
    End If
    On Error GoTo ErrorHandler

    ' === Setup new sheet data with FIXED RANGES ===
    With wsNew
        .Unprotect

        ' Clear any existing data in key cells
        .Range("W6,F2,W7,AZ1").ClearContents

        ' Fill user data with new cell references
        .Range("W6").Value = enterpriseID        ' Enterprise ID in W6
        .Range("F2").Value = employeeName        ' Name in F2
        .Range("W7").Value = employeeEmail       ' Email in W7
        .Range("AZ1").Value = "Added: " & Format(Now, "yyyy-mm-dd hh:mm:ss")

        ' Remove fill formatting from ID and Email cells
        .Range("W6,W7").Interior.ColorIndex = xlNone

        ' Set protection with FIXED ranges
        .Cells.Locked = True

        ' Lock the ID and Email cells (they should not be editable)
        .Range("W6,W7").Locked = True

        ' Unlock data entry fields as per new structure
        .Range("F2").Locked = False          ' Name
        .Range("C6").Locked = False          ' Month
        .Range("E6").Locked = False          ' Week
        .Range("H6").Locked = False          ' Team name
        .Range("B10:B14").Locked = False     ' Region
        .Range("C10:C14").Locked = False     ' Audit Engagement ID
        .Range("D10:D14").Locked = False     ' Engagement Activity
        .Range("E10:E14").Locked = False     ' Hours
        .Range("F10:F14").Locked = False     ' Remark
        .Range("H10:H14").Locked = False     ' Non-Audit Engagement
        .Range("I10:I14").Locked = False     ' Hours
        .Range("J10:J14").Locked = False     ' Remark
        .Range("AT1").Locked = False         ' Additional field
        .Range("B3000:T3200").Locked = False ' FIXED STORAGE AREA (was F24000:P & .Rows.Count)

        .Protect UserInterfaceOnly:=True, AllowFiltering:=True
    End With

    ' === Add to DV sheet ===
    wsDV.Unprotect
    nextDVRow = wsDV.Cells(wsDV.Rows.Count, "F").End(xlUp).Row + 1
    If nextDVRow < 2 Then nextDVRow = 2 ' Start from row 2 if sheet is empty
    wsDV.Range("F" & nextDVRow).Value = enterpriseID
    wsDV.Range("G" & nextDVRow).Value = employeeName
    wsDV.Range("H" & nextDVRow).Value = employeeEmail
    wsDV.Protect UserInterfaceOnly:=True

    ' === Try to copy VBA code (optional - might fail if security high) ===
    On Error Resume Next
    CopySheetMacrosSafe wsForm, wsNew
    On Error GoTo ErrorHandler

    ' === Update counters if function exists ===
    On Error Resume Next
    Call UpdatePendingCounts
    On Error GoTo ErrorHandler

    ' === Clear specified cells on the new user's sheet ===
    ClearNewUserFields wsNew

    Exit Sub

ErrorHandler:
    Err.Raise Err.Number, , Err.Description
End Sub

Private Function SheetExists(sheetName As String) As Boolean
    Dim ws As Worksheet
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets(sheetName)
    SheetExists = Not ws Is Nothing
    On Error GoTo 0
End Function

Private Sub CopySheetMacrosSafe(sourceSheet As Worksheet, targetSheet As Worksheet)
    On Error Resume Next

    Dim sourceCode As Object, targetCode As Object
    Set sourceCode = ThisWorkbook.VBProject.VBComponents(sourceSheet.CodeName)
    Set targetCode = ThisWorkbook.VBProject.VBComponents(targetSheet.CodeName)

    If Not sourceCode Is Nothing And Not targetCode Is Nothing Then
        If sourceCode.CodeModule.CountOfLines > 0 Then
            targetCode.CodeModule.DeleteLines 1, targetCode.CodeModule.CountOfLines
            targetCode.CodeModule.AddFromString sourceCode.CodeModule.Lines(1, sourceCode.CodeModule.CountOfLines)
        End If
    End If

    ' If error occurs, just continue - VBA copying is optional
    On Error GoTo 0
End Sub

Private Sub UpdateLoginDropdown()
    On Error GoTo ErrorHandler

    Dim wsDV As Worksheet
    Dim lastRow As Long, i As Long
    Dim itemValues As Variant

    ' Check if DV sheet exists
    If Not SheetExists("DV") Then
        MsgBox "DV sheet not found. Please check your workbook structure.", vbExclamation
        Exit Sub
    End If

    Set wsDV = ThisWorkbook.Sheets("DV")

    ' Temporarily unprotect DV sheet
    wsDV.Unprotect

    ' Clear existing items in ComboBox
    UserFormLOGIN.ComboBoxID.Clear

    ' Find last row with data in column F
    lastRow = wsDV.Cells(wsDV.Rows.Count, "F").End(xlUp).Row

    If lastRow < 2 Then
        ' No data in DV sheet, leave ComboBox empty
        GoTo CleanUp
    End If

    ' Get the values from DV sheet
    itemValues = wsDV.Range("F2:F" & lastRow).Value

    ' Populate ComboBox with values
    If IsArray(itemValues) Then
        For i = 1 To UBound(itemValues, 1)
            If itemValues(i, 1) <> "" Then ' Only add non-empty values
                UserFormLOGIN.ComboBoxID.AddItem itemValues(i, 1)
            End If
        Next i
    Else
        ' Single value case
        If itemValues <> "" Then
            UserFormLOGIN.ComboBoxID.AddItem itemValues
        End If
    End If

    GoTo CleanUp

ErrorHandler:
    MsgBox "An error occurred while updating the Login dropdown: " & Err.Description, vbCritical, "Error"

CleanUp:
    ' Re-protect DV sheet
    wsDV.Protect UserInterfaceOnly:=True

    ' Set ComboBox style (optional)
    With UserFormLOGIN.ComboBoxID
        .Style = fmStyleDropDownCombo ' Allow typing or selection
        ' .Style = fmStyleDropDownList ' Only allow selection from list
    End With
End Sub


Private Function GetVeryHiddenSheet(sheetName As String) As Worksheet
    Dim ws As Worksheet
    For Each ws In ThisWorkbook.Worksheets
        If ws.Name = sheetName Then
            Set GetVeryHiddenSheet = ws
            Exit Function
        End If
    Next ws
End Function

Private Sub ClearNewUserFields(ws As Worksheet)
    Application.EnableEvents = False
    ws.Unprotect

    ' Clear all data entry fields according to new structure
    ws.Range("C6,E6,H6").ClearContents                    ' Month, Week, Team name
    ws.Range("B10:J14").ClearContents                     ' All engagement fields
    
    ' Set protection with FIXED ranges
    ws.Cells.Locked = True

    ' Lock ID and Email (not editable)
    ws.Range("W6,W7").Locked = True

    ' Unlock all data entry fields with FIXED ranges
    ws.Range("F2").Locked = False          ' Name
    ws.Range("C6").Locked = False          ' Month
    ws.Range("E6").Locked = False          ' Week
    ws.Range("H6").Locked = False          ' Team name
    ws.Range("B10:J14").Locked = False     ' Engagement area
    ws.Range("AT1").Locked = False         ' Additional field
    ws.Range("B3000:T3200").Locked = False ' FIXED STORAGE AREA

    ws.Protect UserInterfaceOnly:=True, AllowFiltering:=True
    Application.EnableEvents = True
End Sub

Public Sub DeleteUserSheet()
    Dim ws As Worksheet
    Dim wsDV As Worksheet
    Dim wsLogin As Worksheet
    Dim userID As String
    Dim dvRow As Long

    ' Get the active sheet
    Set ws = ActiveSheet

    ' Check if the active sheet is a user sheet
    If ws.Name = "Login" Or ws.Name = "DV" Or ws.Name = "Form" Then
        MsgBox "This sheet cannot be deleted.", vbExclamation
        Exit Sub
    End If

    ' Confirm deletion
    If MsgBox("Are you sure you want to delete the sheet for user " & ws.Name & "?", vbYesNo + vbQuestion) = vbNo Then
        Exit Sub
    End If

    userID = ws.Name

    ' Delete the sheet
    Application.DisplayAlerts = False
    ws.Delete
    Application.DisplayAlerts = True

    ' Remove user from DV sheet
    Set wsDV = ThisWorkbook.Sheets("DV")
    dvRow = Application.Match(userID, wsDV.Columns("F"), 0)
    If Not IsError(dvRow) Then
        wsDV.Rows(dvRow).Delete
    End If

    ' Update Login dropdown
    UpdateLoginDropdown

    MsgBox "User sheet and data for " & userID & " have been deleted.", vbInformation
End Sub

' ==================== USER SHEET CODE ====================
Option Explicit

Private Sub Worksheet_Activate()
    ' When sheet is activated, focus on Month selection if Enterprise ID is populated
    If Me.Range("W6").Value <> "" Then
        Me.Range("C6").Select
    End If
End Sub

Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    ' Provide visual feedback when users are in the engagement entry area
    Static lastTarget As Range

    ' Clear previous highlighting
    If Not lastTarget Is Nothing Then
        On Error Resume Next
        lastTarget.Interior.ColorIndex = xlNone
        On Error GoTo 0
        Set lastTarget = Nothing
    End If

    ' Highlight current row if in engagement entry area (rows 10-14)
    If Target.Cells.Count = 1 Then ' Only for single cell selection
        If Target.Row >= 10 And Target.Row <= 14 And Target.Column >= 2 And Target.Column <= 10 Then
            On Error Resume Next
            Me.Range("B" & Target.Row & ":J" & Target.Row).Interior.Color = RGB(245, 245, 245)
            Set lastTarget = Me.Range("B" & Target.Row & ":J" & Target.Row)
            On Error GoTo 0
        End If
    End If
End Sub

' Optional: Clear highlighting when leaving the sheet
Private Sub Worksheet_Deactivate()
    On Error Resume Next
    ' Clear any remaining highlighting
    Me.Range("B10:J14").Interior.ColorIndex = xlNone
    On Error GoTo 0
End Sub

' ==================== THISWORKBOOK CODE ====================
Option Explicit

Private Sub Workbook_Open()
    Dim ws As Worksheet
    Dim excludeSheets As Variant
    excludeSheets = Array("DV", "Admin", "Data base", "Form", "Login")
    
    ' Check if we should show login form
    Dim showLogin As Boolean
    showLogin = True
    
    ' Check current active sheet
    Dim currentSheetName As String
    currentSheetName = ActiveSheet.Name
    
    ' Don't show login form for excluded sheets
    Dim i As Long
    For i = LBound(excludeSheets) To UBound(excludeSheets)
        If currentSheetName = excludeSheets(i) Then
            showLogin = False
            Exit For
        End If
    Next i
    
    ' Show login form if needed
    If showLogin Then
        UserFormLOGIN.Show
    End If
    
    ' Hide all user sheets except the active one
    Application.ScreenUpdating = False
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Login" And ws.Name <> "Data base" And _
           ws.Name <> "DV" And ws.Name <> "Admin" And ws.Name <> "Form" Then
            If ws.Visible = xlSheetVisible And ws.Name <> ActiveSheet.Name Then
                ws.Visible = xlSheetVeryHidden
            End If
        End If
    Next ws
    

    Application.ScreenUpdating = True
End Sub



Private Function IsSheetInUse(ws As Worksheet) As Boolean
    On Error Resume Next
    IsSheetInUse = Not ws.Protection.AllowEditRanges Is Nothing
    On Error GoTo 0
End Function

Private Function IsInCollection(col As collection, val As Variant) As Boolean
    Dim item As Variant
    For Each item In col
        If item = val Then
            IsInCollection = True
            Exit Function
        End If
    Next item
    IsInCollection = False
End Function

Private Sub Workbook_SheetActivate(ByVal Sh As Object)
    On Error Resume Next
    If Sh.Name = "Admin" Then
        Call UpdatePendingCounts
 End If

End Sub

Private Sub Workbook_SheetChange(ByVal Sh As Object, ByVal Target As Range)
    Const YEAR_CELL As String = "H1"
    Const MONTH_CELL As String = "C6"

    On Error GoTo ErrorHandler

    If Not (Intersect(Target, Sh.Range(YEAR_CELL)) Is Nothing And _
            Intersect(Target, Sh.Range(MONTH_CELL)) Is Nothing) Then
        HandleYearMonthChange Sh, Target
    End If

    Exit Sub

ErrorHandler:
    Debug.Print "Error " & Err.Number & ": " & Err.Description
    Application.EnableEvents = True
End Sub

Private Sub HandleYearMonthChange(Sh As Worksheet, Target As Range)
    Const YEAR_CELL As String = "H1"
    Const MONTH_CELL As String = "C6"
    Const WEEK_CELL As String = "E6"

    Dim selectedYear As Integer
    Dim selectedMonth As String
    Dim firstDayOfMonth As Date
    Dim lastDayOfMonth As Date
    Dim currentDate As Date
    Dim weekList As New collection
    Dim weekString As String
    Dim weekArray() As String
    Dim i As Integer

    Application.EnableEvents = False
    UnprotectSheet Sh

    selectedYear = Sh.Range(YEAR_CELL).Value
    selectedMonth = Sh.Range(MONTH_CELL).Value

    If selectedYear = 0 Or selectedMonth = "" Then
        Sh.Range(WEEK_CELL).Value = ""
        If HasValidation(Sh.Range(WEEK_CELL)) Then
            Sh.Range(WEEK_CELL).Validation.Delete
        End If
        GoTo CleanUp
    End If

    firstDayOfMonth = DateSerial(selectedYear, Month(selectedMonth & " 1"), 1)
    lastDayOfMonth = DateSerial(selectedYear, Month(selectedMonth & " 1") + 1, 0)

    currentDate = firstDayOfMonth
    Do While currentDate <= lastDayOfMonth
        If Weekday(currentDate, vbMonday) = 1 Then
            weekString = "Week starting " & Format(currentDate, "mmmm d yyyy")
            weekList.Add weekString
        End If
        currentDate = currentDate + 1
    Loop

    ReDim weekArray(1 To weekList.Count)
    For i = 1 To weekList.Count
        weekArray(i) = weekList(i)
    Next i

    If HasValidation(Sh.Range(WEEK_CELL)) Then
        Sh.Range(WEEK_CELL).Validation.Delete
    End If

    Sh.Range(WEEK_CELL).Validation.Add _
        Type:=xlValidateList, _
        AlertStyle:=xlValidAlertStop, _
        Formula1:=Join(weekArray, ",")

    Sh.Range(WEEK_CELL).Value = ""

CleanUp:
    ProtectSheet Sh
    Application.EnableEvents = True
End Sub

Private Sub Workbook_BeforeClose(Cancel As Boolean)
    Dim userName As String
    Dim ws As Worksheet

    userName = Environ("USERNAME")
    For Each ws In ThisWorkbook.Worksheets
        If LCase(ws.Name) = LCase(userName) Then
            If Not ws.Visible = xlSheetHidden Then
                ws.Visible = xlSheetHidden
            End If
            Exit For
        End If
    Next ws
End Sub

Private Function HasValidation(rng As Range) As Boolean
    On Error Resume Next
    HasValidation = (rng.Validation.Type <> xlValidateInputOnly)
    On Error GoTo 0
End Function

Private Sub UnprotectSheet(ws As Worksheet)
    On Error Resume Next
    ws.Unprotect
    On Error GoTo 0
End Sub




THERE IS BUG IN THIS LINE     ProtectSheet Sh
    Application.EnableEvents = True
End Sub  FIX IT 





' ==================== USERFORM DE CODE (FIXED - UPDATE IN PLACE) ====================
Option Explicit

' Module-level variables
Private currentUserID As String
Private isCorrection As Boolean
Private correctionSource As String ' "LOCAL" or "DATABASE"
Private correctionRowNumber As Long
Private originalRegionItems As collection
Private originalEngagementItems As collection
Private originalActivityItems As collection
Private originalTeamItems As collection
Private originalNEItems As collection

' Variables to store non-editable fields for saving back
Private originalEnterpriseID As String
Private originalEmployeeName As String
Private originalEmployeeEmail As String
Private originalDateTime As String
Private originalType As String
Private originalSubmittedBy As String
Private originalUniqueCode As String

Private Sub UserForm_Initialize()
    isCorrection = False
    correctionSource = ""
    correctionRowNumber = 0

    ' Initialize non-editable field variables
    originalEnterpriseID = ""
    originalEmployeeName = ""
    originalEmployeeEmail = ""
    originalDateTime = ""
    originalType = ""
    originalSubmittedBy = ""
    originalUniqueCode = ""

    ' Initialize original item collections
    Set originalRegionItems = New collection
    Set originalEngagementItems = New collection
    Set originalActivityItems = New collection
    Set originalTeamItems = New collection
    Set originalNEItems = New collection

    Call InitializeComboBoxes
    Call ClearForm(False)
    Call SetupListView

    ' Center the form
    Me.StartUpPosition = 0
    Me.Left = Application.Left + (Application.Width - Me.Width) / 2
    Me.Top = Application.Top + (Application.Height - Me.Height) / 2

    ' Set focus to ComboMonth
    Me.ComboMonth.SetFocus
End Sub

Public Sub LoadEmployeeName()
    ' Get Enterprise ID from active sheet W6 cell
    On Error Resume Next
    currentUserID = Trim(ActiveSheet.Range("W6").Value)
    On Error GoTo 0

    If currentUserID = "" Then
        MsgBox "Enterprise ID not found in cell W6. Please ensure you're logged in properly.", vbExclamation
        Exit Sub
    End If

    ' Search for employee name in DV sheet
    On Error Resume Next
    Dim wsData As Worksheet
    Set wsData = ThisWorkbook.Sheets("DV")

    Dim empName As String
    Dim foundCell As Range

    Set foundCell = wsData.Range("F:F").Find(What:=currentUserID, LookIn:=xlValues, LookAt:=xlWhole)

    If Not foundCell Is Nothing Then
        empName = wsData.Cells(foundCell.Row, "G").Value
        If empName <> "" Then
            Me.TextboxEmpname.Value = empName
            originalEmployeeName = empName  ' Store for later use
        Else
            Me.TextboxEmpname.Value = "Employee Name Not Found"
            originalEmployeeName = "Employee Name Not Found"
        End If
    Else
        empName = Application.WorksheetFunction.VLookup(currentUserID, wsData.Range("F:G"), 2, False)
        If Not IsError(empName) Then
            Me.TextboxEmpname.Value = empName
            originalEmployeeName = empName
        Else
            Me.TextboxEmpname.Value = "Employee Name Not Found"
            originalEmployeeName = "Employee Name Not Found"
        End If
    End If

    On Error GoTo 0

    ' Load all user records initially
    Call LoadAllUserRecords

    ' Set focus to ComboMonth
    Me.ComboMonth.SetFocus
End Sub

Private Sub InitializeComboBoxes()
    On Error Resume Next

    ' Month - Standard months
    With Me.ComboMonth
        .Clear
        .AddItem "January"
        .AddItem "February"
        .AddItem "March"
        .AddItem "April"
        .AddItem "May"
        .AddItem "June"
        .AddItem "July"
        .AddItem "August"
        .AddItem "September"
        .AddItem "October"
        .AddItem "November"
        .AddItem "December"
    End With

    ' Load other dropdowns with unique values
    Call LoadRegionDropdown
    Call LoadActivityDropdown
    Call LoadTeamDropdown
    Call LoadNEDropdown

    On Error GoTo 0
End Sub

Private Sub LoadRegionDropdown()
    Me.ComboRegion.Clear
    Set originalRegionItems = New collection
    Call PopulateComboFromNameManagerUniqueWithCollection(Me.ComboRegion, "Region", originalRegionItems)
End Sub

Private Sub LoadActivityDropdown()
    Me.ComboActi.Clear
    Set originalActivityItems = New collection
    Call PopulateComboFromNameManagerUniqueWithCollection(Me.ComboActi, "EngActivity", originalActivityItems)
End Sub

Private Sub LoadTeamDropdown()
    Me.ComboTeam.Clear
    Set originalTeamItems = New collection
    Call PopulateComboFromNameManagerUniqueWithCollection(Me.ComboTeam, "Team_Name", originalTeamItems)
End Sub

Private Sub LoadNEDropdown()
    Me.ComboNE.Clear
    Set originalNEItems = New collection
    Call PopulateComboFromNameManagerUniqueWithCollection(Me.ComboNE, "Other_than_Eng", originalNEItems)
End Sub

Private Sub LoadEngagementDropdown()
    Me.ComboEng.Clear
    Set originalEngagementItems = New collection

    If Me.ComboRegion.Value <> "" Then
        Dim regionValue As String
        regionValue = Me.ComboRegion.Value
        Dim nameManagerName As String
        nameManagerName = Replace(regionValue, " ", "_")

        Call PopulateComboFromNameManagerUniqueWithCollection(Me.ComboEng, nameManagerName, originalEngagementItems)
    End If
End Sub

Private Sub ComboMonth_Change()
    Call UpdateWeekDropdown
End Sub

Private Sub ComboRegion_Change()
    If Len(Trim(Me.ComboRegion.Value)) > 0 Then
        Call LoadEngagementDropdown
    End If
End Sub

Private Sub UpdateWeekDropdown()
    If Me.ComboMonth.Value = "" Then Exit Sub

    Me.ComboWeek.Clear

    Dim selectedMonth As String
    Dim selectedYear As Integer
    Dim firstDayOfMonth As Date
    Dim lastDayOfMonth As Date
    Dim currentDate As Date
    Dim weekString As String

    selectedMonth = Me.ComboMonth.Value

    On Error Resume Next
    selectedYear = Year(Now)
    On Error GoTo 0

    firstDayOfMonth = DateSerial(selectedYear, Month(selectedMonth & " 1"), 1)
    lastDayOfMonth = DateSerial(selectedYear, Month(selectedMonth & " 1") + 1, 0)

    currentDate = firstDayOfMonth
    Do While currentDate <= lastDayOfMonth
        If Weekday(currentDate, vbMonday) = 1 Then
            weekString = "Week starting " & Format(currentDate, "mmmm d yyyy")
            Me.ComboWeek.AddItem weekString
        End If
        currentDate = currentDate + 1
    Loop
End Sub

Private Sub SetupListView()
    With Me.ListViewRecord
        .View = lvwReport
        .FullRowSelect = True
        .Gridlines = True
        .HideSelection = False
        .LabelWrap = False
        .MultiSelect = False

        ' Clear existing headers
        .ColumnHeaders.Clear

        ' Add column headers (18 columns total)
        .ColumnHeaders.Add , , "Unique Code", 80
        .ColumnHeaders.Add , , "Enterprise ID", 100
        .ColumnHeaders.Add , , "Employee Name", 150
        .ColumnHeaders.Add , , "Employee Email", 120
        .ColumnHeaders.Add , , "Date Time", 140
        .ColumnHeaders.Add , , "Type", 120
        .ColumnHeaders.Add , , "Month", 80
        .ColumnHeaders.Add , , "Week", 180
        .ColumnHeaders.Add , , "Team Name", 120
        .ColumnHeaders.Add , , "Region", 80
        .ColumnHeaders.Add , , "Audit Engagement", 120
        .ColumnHeaders.Add , , "Engagement Activity", 130
        .ColumnHeaders.Add , , "Engagement Hr", 110
        .ColumnHeaders.Add , , "Remark 1", 100
        .ColumnHeaders.Add , , "Non-Audit Eng", 120
        .ColumnHeaders.Add , , "Non-Audit Hr", 90
        .ColumnHeaders.Add , , "Remark 2", 100
        .ColumnHeaders.Add , , "Submitted By", 120
    End With
End Sub

Private Sub LoadAllUserRecords()
    On Error GoTo ErrorHandler

    If currentUserID = "" Then
        MsgBox "Enterprise ID not available. Please ensure you're logged in properly.", vbExclamation
        Exit Sub
    End If

    ' Clear ListView
    Me.ListViewRecord.ListItems.Clear

    Dim recordCount As Long
    recordCount = 0

    ' Load records from Database first
    recordCount = recordCount + LoadRecordsFromDatabase()

    ' Load records from Local storage (within fixed range)
    recordCount = recordCount + LoadRecordsFromLocal()

    If recordCount > 0 Then
        'MsgBox "Loaded " & recordCount & " records. Double-click a record to edit it.", vbInformation
    Else
        MsgBox "No records found for Enterprise ID: " & currentUserID, vbInformation
    End If

    Exit Sub

ErrorHandler:
    MsgBox "Error loading records: " & Err.Description, vbCritical
End Sub

Private Function LoadRecordsFromDatabase() As Long
    On Error Resume Next
    Dim wsDB As Worksheet
    Set wsDB = ThisWorkbook.Sheets("Data base")

    Dim lastRow As Long
    Dim r As Long
    Dim recordCount As Long

    recordCount = 0
    lastRow = wsDB.Cells(wsDB.Rows.Count, 1).End(xlUp).Row

    For r = 2 To lastRow
        If wsDB.Cells(r, 2).Value = currentUserID Then ' Column 2 = Enterprise ID
            Dim listItem As listItem
            Set listItem = Me.ListViewRecord.ListItems.Add(, , wsDB.Cells(r, 1).Value)  ' Unique Code

            ' Set a key for tracking: SOURCE_ROWNUMBER
            listItem.Key = "DB_" & r

            ' Add subitems for remaining 17 columns
            listItem.SubItems(1) = CStr(wsDB.Cells(r, 2).Value)   ' Enterprise ID
            listItem.SubItems(2) = CStr(wsDB.Cells(r, 3).Value)   ' Employee Name
            listItem.SubItems(3) = CStr(wsDB.Cells(r, 4).Value)   ' Employee Email
            listItem.SubItems(4) = CStr(wsDB.Cells(r, 5).Value)   ' Date Time
            listItem.SubItems(5) = CStr(wsDB.Cells(r, 6).Value)   ' Type
            listItem.SubItems(6) = CStr(wsDB.Cells(r, 7).Value)   ' Month
            listItem.SubItems(7) = CStr(wsDB.Cells(r, 8).Value)   ' Week
            listItem.SubItems(8) = CStr(wsDB.Cells(r, 9).Value)   ' Team Name
            listItem.SubItems(9) = CStr(wsDB.Cells(r, 10).Value)  ' Region
            listItem.SubItems(10) = CStr(wsDB.Cells(r, 11).Value) ' Audit Engagement
            listItem.SubItems(11) = CStr(wsDB.Cells(r, 12).Value) ' Engagement Activity
            listItem.SubItems(12) = CStr(wsDB.Cells(r, 13).Value) ' Engagement Hr
            listItem.SubItems(13) = CStr(wsDB.Cells(r, 14).Value) ' Remark 1
            listItem.SubItems(14) = CStr(wsDB.Cells(r, 15).Value) ' Non-Audit Eng
            listItem.SubItems(15) = CStr(wsDB.Cells(r, 16).Value) ' Non-Audit Hr
            listItem.SubItems(16) = CStr(wsDB.Cells(r, 17).Value) ' Remark 2
            listItem.SubItems(17) = CStr(wsDB.Cells(r, 18).Value) ' Submitted By

            recordCount = recordCount + 1
        End If
    Next r

    LoadRecordsFromDatabase = recordCount
End Function

Private Function LoadRecordsFromLocal() As Long
    On Error Resume Next
    Dim wsUser As Worksheet
    Set wsUser = ActiveSheet

    Dim r As Long
    Dim recordCount As Long

    recordCount = 0

    ' Check within fixed range (3000-3200)
    For r = 3000 To 3200
        If wsUser.Cells(r, 3).Value = currentUserID Then ' Column 3 = Enterprise ID
            Dim listItem As listItem
            Set listItem = Me.ListViewRecord.ListItems.Add(, , wsUser.Cells(r, 2).Value)  ' Unique Code

            ' Set a key for tracking: SOURCE_ROWNUMBER
            listItem.Key = "LOCAL_" & r

            ' Add subitems for remaining 17 columns
            listItem.SubItems(1) = CStr(wsUser.Cells(r, 3).Value)   ' Enterprise ID
            listItem.SubItems(2) = CStr(wsUser.Cells(r, 4).Value)   ' Employee Name
            listItem.SubItems(3) = CStr(wsUser.Cells(r, 5).Value)   ' Employee Email
            listItem.SubItems(4) = CStr(wsUser.Cells(r, 6).Value)   ' Date Time
            listItem.SubItems(5) = CStr(wsUser.Cells(r, 7).Value)   ' Type
            listItem.SubItems(6) = CStr(wsUser.Cells(r, 8).Value)   ' Month
            listItem.SubItems(7) = CStr(wsUser.Cells(r, 9).Value)   ' Week
            listItem.SubItems(8) = CStr(wsUser.Cells(r, 10).Value)  ' Team Name
            listItem.SubItems(9) = CStr(wsUser.Cells(r, 11).Value)  ' Region
            listItem.SubItems(10) = CStr(wsUser.Cells(r, 12).Value) ' Audit Engagement
            listItem.SubItems(11) = CStr(wsUser.Cells(r, 13).Value) ' Engagement Activity
            listItem.SubItems(12) = CStr(wsUser.Cells(r, 14).Value) ' Engagement Hr
            listItem.SubItems(13) = CStr(wsUser.Cells(r, 15).Value) ' Remark 1
            listItem.SubItems(14) = CStr(wsUser.Cells(r, 16).Value) ' Non-Audit Eng
            listItem.SubItems(15) = CStr(wsUser.Cells(r, 17).Value) ' Non-Audit Hr
            listItem.SubItems(16) = CStr(wsUser.Cells(r, 18).Value) ' Remark 2
            listItem.SubItems(17) = CStr(wsUser.Cells(r, 19).Value) ' Submitted By

            recordCount = recordCount + 1
        End If
    Next r

    LoadRecordsFromLocal = recordCount
End Function

Private Sub ListViewRecord_DblClick()
    If Me.ListViewRecord.selectedItem Is Nothing Then Exit Sub

    Dim selectedItem As listItem
    Set selectedItem = Me.ListViewRecord.selectedItem

    ' Extract source and row number from key
    Dim keyParts As Variant
    keyParts = Split(selectedItem.Key, "_")
    correctionSource = keyParts(0)
    correctionRowNumber = CLng(keyParts(1))

    ' Load record for correction directly from ListView
    If LoadRecordFromListView(selectedItem) Then
        isCorrection = True
        Me.Caption = "Timesheet Data Entry - CORRECTION MODE (" & correctionSource & ")"
        MsgBox "Record loaded for correction from " & correctionSource & ". Modify editable fields as needed and click 'Correct Record'." & vbCrLf & _
               "The existing record will be updated in place.", vbInformation
        ' Set focus to ComboMonth for correction
        Me.ComboMonth.SetFocus
    Else
        MsgBox "Error loading record for correction.", vbExclamation
    End If
End Sub

Private Function GetSafeSubItemValue(selectedItem As listItem, index As Integer) As String
    On Error GoTo SafeExit

    Dim subItemValue As Variant

    On Error Resume Next
    subItemValue = selectedItem.SubItems(index)

    If Err.Number <> 0 Then
        GetSafeSubItemValue = ""
        Err.Clear
        On Error GoTo 0
        Exit Function
    End If

    On Error GoTo 0

    If IsEmpty(subItemValue) Or IsNull(subItemValue) Or subItemValue = "" Then
        GetSafeSubItemValue = ""
    Else
        GetSafeSubItemValue = Trim(CStr(subItemValue))
    End If

    Exit Function

SafeExit:
    GetSafeSubItemValue = ""
End Function

Private Function LoadRecordFromListView(selectedItem As listItem) As Boolean
    On Error GoTo ErrorHandler

    LoadRecordFromListView = False

    ' Clear form first
    Call ClearForm(True)

    ' Re-initialize combo boxes
    Call InitializeComboBoxes

    ' ============================================================
    ' STORE NON-EDITABLE FIELDS
    ' ============================================================
    ' 1. Unique Code (Text property)
    originalUniqueCode = selectedItem.Text

    ' 2. Enterprise ID (SubItem index 1)
    originalEnterpriseID = GetSafeSubItemValue(selectedItem, 1)

    ' 3. Employee Name (SubItem index 2)
    originalEmployeeName = GetSafeSubItemValue(selectedItem, 2)
    Me.TextboxEmpname.Value = originalEmployeeName

    ' 4. Employee Email (SubItem index 3)
    originalEmployeeEmail = GetSafeSubItemValue(selectedItem, 3)

    ' 5. Date Time (SubItem index 4)
    originalDateTime = GetSafeSubItemValue(selectedItem, 4)

    ' 6. Type (SubItem index 5)
    originalType = GetSafeSubItemValue(selectedItem, 5)

    ' 7. Submitted By (SubItem index 17)
    originalSubmittedBy = GetSafeSubItemValue(selectedItem, 17)

    ' ============================================================
    ' LOAD EDITABLE FIELDS INTO FORM CONTROLS
    ' ============================================================

    ' 1. Month (SubItem index 6)
    Dim monthValue As String
    monthValue = GetSafeSubItemValue(selectedItem, 6)
    If monthValue <> "" Then
        Me.ComboMonth.Value = monthValue
        Call UpdateWeekDropdown
    End If

    ' 2. Week (SubItem index 7)
    Dim weekValue As String
    weekValue = GetSafeSubItemValue(selectedItem, 7)
    If weekValue <> "" Then
        Me.ComboWeek.Value = weekValue
    End If

    ' 3. Team (SubItem index 8)
    Dim teamValue As String
    teamValue = GetSafeSubItemValue(selectedItem, 8)
    If teamValue <> "" Then
        Me.ComboTeam.Value = teamValue
    End If

    ' 4. Region (SubItem index 9)
    Dim regionValue As String
    regionValue = GetSafeSubItemValue(selectedItem, 9)
    If regionValue <> "" Then
        Me.ComboRegion.Value = regionValue
        Call LoadEngagementDropdown
    End If

    ' 5. Engagement (SubItem index 10)
    Dim engValue As String
    engValue = GetSafeSubItemValue(selectedItem, 10)
    If engValue <> "" Then
        Me.ComboEng.Value = engValue
    End If

    ' 6. Activity (SubItem index 11)
    Dim actiValue As String
    actiValue = GetSafeSubItemValue(selectedItem, 11)
    If actiValue <> "" Then
        Me.ComboActi.Value = actiValue
    End If

    ' 7. Hours and remarks
    Me.TextBoxHour1.Value = GetSafeSubItemValue(selectedItem, 12)  ' Engagement Hr
    Me.TextBoxR1.Value = GetSafeSubItemValue(selectedItem, 13)     ' Remark 1

    ' 8. Non-Engagement fields
    Dim neValue As String
    neValue = GetSafeSubItemValue(selectedItem, 14)  ' Non-Audit Eng
    If neValue <> "" Then
        Me.ComboNE.Value = neValue
    End If

    Me.TextBoxH2.Value = GetSafeSubItemValue(selectedItem, 15)  ' Non-Audit Hr
    Me.TextBoxR2.Value = GetSafeSubItemValue(selectedItem, 16)  ' Remark 2

    LoadRecordFromListView = True
    Exit Function

ErrorHandler:
    MsgBox "Error in LoadRecordFromListView: " & Err.Description & vbCrLf & _
           "Error Number: " & Err.Number, vbCritical
    LoadRecordFromListView = False
End Function

Private Sub Commandcorrec_Click()
    If Not isCorrection Then
        MsgBox "Please select a record to correct by double-clicking it in the list.", vbExclamation
        Exit Sub
    End If

    If ValidateForm() Then
        Call SaveCorrectedRecord
        isCorrection = False
        correctionSource = ""
        correctionRowNumber = 0
        Me.Caption = "Timesheet Data Entry"
        Call ClearForm(False)
        Call LoadAllUserRecords ' Refresh the list
        ' Set focus back to ComboMonth
        Me.ComboMonth.SetFocus
    End If
End Sub

Private Function ValidateForm() As Boolean
    ValidateForm = True

    ' Basic field validation
    If Me.ComboMonth.Value = "" Then
        MsgBox "Please select Month.", vbExclamation: ValidateForm = False: Exit Function
    End If
    If Me.ComboWeek.Value = "" Then
        MsgBox "Please select Week.", vbExclamation: ValidateForm = False: Exit Function
    End If
    If Me.ComboTeam.Value = "" Then
        MsgBox "Please select Team.", vbExclamation: ValidateForm = False: Exit Function
    End If

    ' Check if at least one engagement is filled
    Dim eng1Filled As Boolean
    Dim eng2Filled As Boolean

    eng1Filled = (Me.ComboEng.Value <> "" And Me.TextBoxHour1.Value <> "")
    eng2Filled = (Me.ComboNE.Value <> "" And Me.TextBoxH2.Value <> "")

    If Not (eng1Filled Or eng2Filled) Then
        MsgBox "Please fill at least one engagement section.", vbExclamation
        ValidateForm = False: Exit Function
    End If

    ' Validate engagement section if filled
    If eng1Filled Then
        If Me.ComboActi.Value = "" Then
            MsgBox "Please select Engagement Activity when Engagement Name and Hours are specified.", vbExclamation
            ValidateForm = False: Exit Function
        End If
        If Me.ComboRegion.Value = "" Then
            MsgBox "Please select Region when Audit Engagement is specified.", vbExclamation
            ValidateForm = False: Exit Function
        End If

        ' Validate hours range (1-300)
        If Not IsNumeric(Me.TextBoxHour1.Value) Then
            MsgBox "Please enter a valid number for Engagement Hours.", vbExclamation
            ValidateForm = False: Exit Function
        End If
        Dim hours1 As Double
        hours1 = CDbl(Me.TextBoxHour1.Value)
        If hours1 < 1 Or hours1 > 300 Then
            MsgBox "Engagement Hours must be between 1 and 300.", vbExclamation
            ValidateForm = False: Exit Function
        End If
    End If

    ' Validate second engagement section if filled
    If eng2Filled Then
        ' Validate hours range (1-300)
        If Not IsNumeric(Me.TextBoxH2.Value) Then
            MsgBox "Please enter a valid number for Other Hours.", vbExclamation
            ValidateForm = False: Exit Function
        End If
        Dim hours2 As Double
        hours2 = CDbl(Me.TextBoxH2.Value)
        If hours2 < 1 Or hours2 > 300 Then
            MsgBox "Other Hours must be between 1 and 300.", vbExclamation
            ValidateForm = False: Exit Function
        End If
    End If
End Function

' ============================================================
' UPDATE IN PLACE CORRECTION LOGIC
' ============================================================
Private Sub SaveCorrectedRecord()
    On Error GoTo ErrorHandler

    Application.EnableEvents = False

    ' Update the existing record in place
    If correctionSource = "DATABASE" Then
        Call UpdateDatabaseRecord
    Else
        Call UpdateLocalRecord
    End If

    Application.EnableEvents = True

    ThisWorkbook.Save

    MsgBox "SUCCESS! CORRECTION completed!" & vbCrLf & _
           "Record updated in place in " & correctionSource & ".", vbInformation, "Correction Complete"

    Exit Sub

ErrorHandler:
    MsgBox "Error saving correction: " & Err.Description, vbCritical
    On Error Resume Next
    Application.EnableEvents = True
End Sub

Private Sub UpdateDatabaseRecord()
    Dim wsDB As Worksheet
    Set wsDB = ThisWorkbook.Sheets("Data base")

    wsDB.Unprotect

    ' Update the existing record in place
    With wsDB
        ' Preserve original unique code and ID
        .Cells(correctionRowNumber, 1).Value = originalUniqueCode       ' Unique Code
        .Cells(correctionRowNumber, 2).Value = originalEnterpriseID     ' Enterprise ID
        
        ' Update Name and Email (preserved from original)
        .Cells(correctionRowNumber, 3).Value = originalEmployeeName     ' Employee Name
        .Cells(correctionRowNumber, 4).Value = originalEmployeeEmail    ' Employee Email
        
        ' Update Date Time to show when correction was made
        .Cells(correctionRowNumber, 5).Value = Format(Now, "yyyy-mm-dd hh:mm:ss")
        
        ' Update Type to indicate this is a correction
        .Cells(correctionRowNumber, 6).Value = "Timesheet Correction"
        
        ' Update editable fields with new values
        .Cells(correctionRowNumber, 7).Value = Me.ComboMonth.Value      ' Month
        .Cells(correctionRowNumber, 8).Value = Me.ComboWeek.Value       ' Week
        .Cells(correctionRowNumber, 9).Value = Me.ComboTeam.Value       ' Team Name
        .Cells(correctionRowNumber, 10).Value = Me.ComboRegion.Value    ' Region
        .Cells(correctionRowNumber, 11).Value = Me.ComboEng.Value       ' Audit Engagement
        .Cells(correctionRowNumber, 12).Value = Me.ComboActi.Value      ' Engagement Activity
        .Cells(correctionRowNumber, 13).Value = Me.TextBoxHour1.Value   ' Engagement Hr
        .Cells(correctionRowNumber, 14).Value = Me.TextBoxR1.Value      ' Remark 1
        .Cells(correctionRowNumber, 15).Value = Me.ComboNE.Value        ' Non-Audit Eng
        .Cells(correctionRowNumber, 16).Value = Me.TextBoxH2.Value      ' Non-Audit Hr
        .Cells(correctionRowNumber, 17).Value = Me.TextBoxR2.Value      ' Remark 2
        .Cells(correctionRowNumber, 18).Value = Application.userName    ' Submitted By (current user)
    End With

    wsDB.Protect UserInterfaceOnly:=True
End Sub

Private Sub UpdateLocalRecord()
    Dim wsUser As Worksheet
    Set wsUser = ActiveSheet

    wsUser.Unprotect

    ' Update the existing record in place
    With wsUser
        ' Preserve original unique code and ID
        .Cells(correctionRowNumber, 2).Value = originalUniqueCode       ' Unique Code
        .Cells(correctionRowNumber, 3).Value = originalEnterpriseID     ' Enterprise ID
        
        ' Update Name and Email (preserved from original)
        .Cells(correctionRowNumber, 4).Value = originalEmployeeName     ' Employee Name
        .Cells(correctionRowNumber, 5).Value = originalEmployeeEmail    ' Employee Email
        
        ' Update Date Time to show when correction was made
        .Cells(correctionRowNumber, 6).Value = Format(Now, "yyyy-mm-dd hh:mm:ss")
        
        ' Update Type to indicate this is a correction
        .Cells(correctionRowNumber, 7).Value = "Timesheet Correction"
        
        ' Update editable fields with new values
        .Cells(correctionRowNumber, 8).Value = Me.ComboMonth.Value      ' Month
        .Cells(correctionRowNumber, 9).Value = Me.ComboWeek.Value       ' Week
        .Cells(correctionRowNumber, 10).Value = Me.ComboTeam.Value      ' Team Name
        .Cells(correctionRowNumber, 11).Value = Me.ComboRegion.Value    ' Region
        .Cells(correctionRowNumber, 12).Value = Me.ComboEng.Value       ' Audit Engagement
        .Cells(correctionRowNumber, 13).Value = Me.ComboActi.Value      ' Engagement Activity
        .Cells(correctionRowNumber, 14).Value = Me.TextBoxHour1.Value   ' Engagement Hr
        .Cells(correctionRowNumber, 15).Value = Me.TextBoxR1.Value      ' Remark 1
        .Cells(correctionRowNumber, 16).Value = Me.ComboNE.Value        ' Non-Audit Eng
        .Cells(correctionRowNumber, 17).Value = Me.TextBoxH2.Value      ' Non-Audit Hr
        .Cells(correctionRowNumber, 18).Value = Me.TextBoxR2.Value      ' Remark 2
        .Cells(correctionRowNumber, 19).Value = Application.userName    ' Submitted By (current user)

        ' Maintain font color to white (hidden) for local storage
        .Range(.Cells(correctionRowNumber, 2), .Cells(correctionRowNumber, 19)).Font.Color = RGB(255, 255, 255)
    End With

    wsUser.Protect UserInterfaceOnly:=True
End Sub

Private Sub ClearForm(clearAll As Boolean)
    ' Always clear these fields (non-preserved)
    Me.ComboEng.Value = ""
    Me.ComboActi.Value = ""
    Me.TextBoxHour1.Value = ""
    Me.TextBoxR1.Value = ""
    Me.ComboNE.Value = ""
    Me.TextBoxH2.Value = ""
    Me.TextBoxR2.Value = ""
    Me.ComboRegion.Value = ""

    If clearAll Then
        Me.TextboxEmpname.Value = ""
        Me.ComboMonth.Value = ""
        Me.ComboWeek.Value = ""
        Me.ComboTeam.Value = ""

        ' Reset non-editable field variables
        originalEnterpriseID = ""
        originalEmployeeName = ""
        originalEmployeeEmail = ""
        originalDateTime = ""
        originalType = ""
        originalSubmittedBy = ""
        originalUniqueCode = ""
    End If

    ' Set focus to ComboMonth after clearing
    Me.ComboMonth.SetFocus
End Sub

Private Sub Commandfilter_Click()
    Call FilterRecords
End Sub

Private Sub FilterRecords()
    On Error GoTo ErrorHandler

    If currentUserID = "" Then
        MsgBox "Enterprise ID not available. Please ensure you're logged in properly.", vbExclamation
        Exit Sub
    End If

    ' Clear ListView
    Me.ListViewRecord.ListItems.Clear

    Dim recordCount As Long
    recordCount = 0

    ' Filter records from Database
    recordCount = recordCount + FilterRecordsFromDatabase()

    ' Filter records from Local storage
    recordCount = recordCount + FilterRecordsFromLocal()

    If recordCount > 0 Then
        MsgBox "Filtered " & recordCount & " records based on your criteria.", vbInformation
    Else
        MsgBox "No records found matching your filter criteria.", vbInformation
    End If

    Exit Sub

ErrorHandler:
    MsgBox "Error filtering records: " & Err.Description, vbCritical
End Sub

Private Function FilterRecordsFromDatabase() As Long
    On Error Resume Next
    Dim wsDB As Worksheet
    Set wsDB = ThisWorkbook.Sheets("Data base")

    Dim lastRow As Long
    Dim r As Long
    Dim recordCount As Long
    Dim includeRecord As Boolean

    recordCount = 0
    lastRow = wsDB.Cells(wsDB.Rows.Count, 1).End(xlUp).Row

    For r = 2 To lastRow
        If wsDB.Cells(r, 2).Value = currentUserID Then
            includeRecord = True

            ' Apply filters based on form selections
            If Me.ComboMonth.Value <> "" And wsDB.Cells(r, 7).Value <> Me.ComboMonth.Value Then
                includeRecord = False
            End If

            If Me.ComboWeek.Value <> "" And wsDB.Cells(r, 8).Value <> Me.ComboWeek.Value Then
                includeRecord = False
            End If

            If Me.ComboTeam.Value <> "" And wsDB.Cells(r, 9).Value <> Me.ComboTeam.Value Then
                includeRecord = False
            End If

            If Me.ComboRegion.Value <> "" And wsDB.Cells(r, 10).Value <> Me.ComboRegion.Value Then
                includeRecord = False
            End If

            If Me.ComboEng.Value <> "" And wsDB.Cells(r, 11).Value <> Me.ComboEng.Value Then
                includeRecord = False
            End If

            If Me.ComboActi.Value <> "" And wsDB.Cells(r, 12).Value <> Me.ComboActi.Value Then
                includeRecord = False
            End If

            If Me.ComboNE.Value <> "" And wsDB.Cells(r, 15).Value <> Me.ComboNE.Value Then
                includeRecord = False
            End If

            If includeRecord Then
                Dim listItem As listItem
                Set listItem = Me.ListViewRecord.ListItems.Add(, , wsDB.Cells(r, 1).Value)
                listItem.Key = "DB_" & r

                ' Add subitems
                listItem.SubItems(1) = CStr(wsDB.Cells(r, 2).Value)   ' Enterprise ID
                listItem.SubItems(2) = CStr(wsDB.Cells(r, 3).Value)   ' Employee Name
                listItem.SubItems(3) = CStr(wsDB.Cells(r, 4).Value)   ' Employee Email
                listItem.SubItems(4) = CStr(wsDB.Cells(r, 5).Value)   ' Date Time
                listItem.SubItems(5) = CStr(wsDB.Cells(r, 6).Value)   ' Type
                listItem.SubItems(6) = CStr(wsDB.Cells(r, 7).Value)   ' Month
                listItem.SubItems(7) = CStr(wsDB.Cells(r, 8).Value)   ' Week
                listItem.SubItems(8) = CStr(wsDB.Cells(r, 9).Value)   ' Team Name
                listItem.SubItems(9) = CStr(wsDB.Cells(r, 10).Value)  ' Region
                listItem.SubItems(10) = CStr(wsDB.Cells(r, 11).Value) ' Audit Engagement
                listItem.SubItems(11) = CStr(wsDB.Cells(r, 12).Value) ' Engagement Activity
                listItem.SubItems(12) = CStr(wsDB.Cells(r, 13).Value) ' Engagement Hr
                listItem.SubItems(13) = CStr(wsDB.Cells(r, 14).Value) ' Remark 1
                listItem.SubItems(14) = CStr(wsDB.Cells(r, 15).Value) ' Non-Audit Eng
                listItem.SubItems(15) = CStr(wsDB.Cells(r, 16).Value) ' Non-Audit Hr
                listItem.SubItems(16) = CStr(wsDB.Cells(r, 17).Value) ' Remark 2
                listItem.SubItems(17) = CStr(wsDB.Cells(r, 18).Value) ' Submitted By

                recordCount = recordCount + 1
            End If
        End If
    Next r

    FilterRecordsFromDatabase = recordCount
End Function

Private Function FilterRecordsFromLocal() As Long
    On Error Resume Next
    Dim wsUser As Worksheet
    Set wsUser = ActiveSheet

    Dim r As Long
    Dim recordCount As Long
    Dim includeRecord As Boolean

    recordCount = 0

    ' Check within fixed range (3000-3200)
    For r = 3000 To 3200
        If wsUser.Cells(r, 3).Value = currentUserID Then
            includeRecord = True

            ' Apply filters based on form selections
            If Me.ComboMonth.Value <> "" And wsUser.Cells(r, 8).Value <> Me.ComboMonth.Value Then
                includeRecord = False
            End If

            If Me.ComboWeek.Value <> "" And wsUser.Cells(r, 9).Value <> Me.ComboWeek.Value Then
                includeRecord = False
            End If

            If Me.ComboTeam.Value <> "" And wsUser.Cells(r, 10).Value <> Me.ComboTeam.Value Then
                includeRecord = False
            End If

            If Me.ComboRegion.Value <> "" And wsUser.Cells(r, 11).Value <> Me.ComboRegion.Value Then
                includeRecord = False
            End If

            If Me.ComboEng.Value <> "" And wsUser.Cells(r, 12).Value <> Me.ComboEng.Value Then
                includeRecord = False
            End If

            If Me.ComboActi.Value <> "" And wsUser.Cells(r, 13).Value <> Me.ComboActi.Value Then
                includeRecord = False
            End If

            If Me.ComboNE.Value <> "" And wsUser.Cells(r, 16).Value <> Me.ComboNE.Value Then
                includeRecord = False
            End If

            If includeRecord Then
                Dim listItem As listItem
                Set listItem = Me.ListViewRecord.ListItems.Add(, , wsUser.Cells(r, 2).Value)
                listItem.Key = "LOCAL_" & r

                ' Add subitems
                listItem.SubItems(1) = CStr(wsUser.Cells(r, 3).Value)   ' Enterprise ID
                listItem.SubItems(2) = CStr(wsUser.Cells(r, 4).Value)   ' Employee Name
                listItem.SubItems(3) = CStr(wsUser.Cells(r, 5).Value)   ' Employee Email
                listItem.SubItems(4) = CStr(wsUser.Cells(r, 6).Value)   ' Date Time
                listItem.SubItems(5) = CStr(wsUser.Cells(r, 7).Value)   ' Type
                listItem.SubItems(6) = CStr(wsUser.Cells(r, 8).Value)   ' Month
                listItem.SubItems(7) = CStr(wsUser.Cells(r, 9).Value)   ' Week
                listItem.SubItems(8) = CStr(wsUser.Cells(r, 10).Value)  ' Team Name
                listItem.SubItems(9) = CStr(wsUser.Cells(r, 11).Value)  ' Region
                listItem.SubItems(10) = CStr(wsUser.Cells(r, 12).Value) ' Audit Engagement
                listItem.SubItems(11) = CStr(wsUser.Cells(r, 13).Value) ' Engagement Activity
                listItem.SubItems(12) = CStr(wsUser.Cells(r, 14).Value) ' Engagement Hr
                listItem.SubItems(13) = CStr(wsUser.Cells(r, 15).Value) ' Remark 1
                listItem.SubItems(14) = CStr(wsUser.Cells(r, 16).Value) ' Non-Audit Eng
                listItem.SubItems(15) = CStr(wsUser.Cells(r, 17).Value) ' Non-Audit Hr
                listItem.SubItems(16) = CStr(wsUser.Cells(r, 18).Value) ' Remark 2
                listItem.SubItems(17) = CStr(wsUser.Cells(r, 19).Value) ' Submitted By

                recordCount = recordCount + 1
            End If
        End If
    Next r

    FilterRecordsFromLocal = recordCount
End Function

Private Function ValidateComboBoxValue(combo As MSForms.comboBox, Value As String) As Boolean
    Dim i As Integer
    ValidateComboBoxValue = False

    For i = 0 To combo.ListCount - 1
        If combo.List(i) = Value Then
            ValidateComboBoxValue = True
            Exit Function
        End If
    Next i
End Function

Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    If CloseMode = vbFormControlMenu Then
        Dim response As VbMsgBoxResult
        response = MsgBox("Are you sure you want to close the correction form?", vbYesNo + vbQuestion, "Confirm Close")

        If response = vbNo Then
            Cancel = True
        End If
    End If
End Sub

Private Sub PopulateComboFromNameManagerUniqueWithCollection(combo As MSForms.comboBox, nameManagerName As String, col As collection)
    On Error Resume Next

    Dim nameRange As Range
    Set nameRange = ThisWorkbook.Names(nameManagerName).RefersToRange

    If Not nameRange Is Nothing Then
        Dim cell As Range
        Dim itemValue As String
        Dim itemExists As Boolean

        ' Clear the collection
        Set col = New collection
        combo.Clear

        For Each cell In nameRange
            If cell.Value <> "" Then
                itemValue = Trim(CStr(cell.Value))
                itemExists = False

                ' Check if item already exists in collection
                On Error Resume Next
                Dim testItem As String
                testItem = col(itemValue)
                If Err.Number = 0 Then
                    itemExists = True
                End If
                Err.Clear
                On Error GoTo 0

                ' Add unique items only
                If Not itemExists Then
                    col.Add itemValue, itemValue
                    combo.AddItem itemValue
                End If
            End If
        Next cell
    End If

    On Error GoTo 0
End Sub

Private Sub CommandClose_Click()
    Unload Me
End Sub

' ==================== USERFORM LOGIN CODE ====================
Option Explicit

Private Sub UserForm_Initialize()
    ' Center form and populate Enterprise IDs
    Me.StartUpPosition = 0
    Me.Left = Application.Left + (Application.Width - Me.Width) / 2
    Me.Top = Application.Top + (Application.Height - Me.Height) / 2
    
    PopulateEnterpriseIDs
    Me.ComboBoxID.SetFocus
End Sub

Private Sub PopulateEnterpriseIDs()
    ' Populate from DV sheet column F
    Dim wsDV As Worksheet, lastRow As Long, i As Long
    Dim dict As Object
    Set dict = CreateObject("Scripting.Dictionary")
    
    Set wsDV = ThisWorkbook.Sheets("DV")
    lastRow = wsDV.Cells(wsDV.Rows.Count, "F").End(xlUp).Row
    
    Me.ComboBoxID.Clear
    Me.ComboBoxID.AddItem ""
    
    For i = 2 To lastRow
        Dim entID As String
        entID = Trim(wsDV.Cells(i, "F").Value)
        If entID <> "" And Not dict.exists(entID) Then
            dict.Add entID, True
            Me.ComboBoxID.AddItem entID
        End If
    Next i
End Sub

Private Sub CommandButtonLogin_Click()
    If Me.ComboBoxID.Value = "" Then
        MsgBox "Please select an Enterprise ID", vbExclamation
        Me.ComboBoxID.SetFocus
        Exit Sub
    End If
    
    Call LoginUserFromForm(Me.ComboBoxID.Value)
    Unload Me
End Sub

Private Sub CommandButtonCancel_Click()
    Unload Me
End Sub

Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    If CloseMode = vbFormControlMenu Then
        Dim response As VbMsgBoxResult
        response = MsgBox("Are you sure you want to cancel login?", vbYesNo + vbQuestion, "Confirm Cancel")
        
        If response = vbNo Then
            Cancel = True
        End If
    End If
End Sub




SEE ANALYZE MY OLD CODE AND mAKE SOME FIXES IN NEW CODE OKAY
1. LIKE EARLIER HOW CORRECTION ARE HANDLED I WANT SAME THING JUST A NEW UserFormDE  WHERE AFTER CLICKING CORRECTION LOAD RECORD AND HERE USER CAN FILTER BY USING Commandfilter  IN ListViewRecord bASED ON THE VALUE OF ComboActi
ComboNE TextboxEmpname
ComboMonth
ComboWeek
ComboRegion
ComboTeam
ComboEng
OKAY AND IN PLACE OF LOGIN SHEET NOW I HAVE UserFormLOGIN  IT HANDLE OLD FEATURE OKAY 
AND 


IN Data base sheet now store value in this sequence Enterprise ID	Employee Name	Email	Date and time of Timesheet entry	New Timesheet/Timesheet Correction	Month	Week	Team Name	Region	 Audit Engagment name 	Engagement Activity	Engagement Actual hours	Remark 1	Other than Engagement?	Others Actual hours	Remark 2	User Submitted Record
  and why in new code usersubmitted name  is not there and for unique code since now user can submit upto 5 record then appply 5 diferent unique no. like 1,2,3, so on for next store unique code in 5 cell like if user had filled till 30 record now if user submit 3 new record then unique code is like 31,32,33 okay like this and why in new code toggle my past record not load data from Data base fix these  

